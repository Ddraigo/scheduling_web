{% extends "admin/base.html" %}
{% load static i18n %}

{% block title %}{{ title }} {% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Trang ch·ªß</a>
    &rsaquo; <a href="{% url 'admin:sap_lich_saplichproxy_changelist' %}">S·∫Øp l·ªãch</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}


{% block content %}

<!-- Control Panel -->
<div class="card mb-4">
    <div class="card-header">
        <h5>‚öôÔ∏è B·∫£ng ƒëi·ªÅu khi·ªÉn</h5>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label for="periodSelect">Ch·ªçn ƒë·ª£t x·∫øp:</label>
            <select id="periodSelect" class="form-control">
                <option value="">-- Ch·ªçn ƒë·ª£t --</option>
                {% for period in periods %}
                <option value="{{ period.ma_dot }}">
                    {{ period.ma_dot }} - {{ period.ten_dot }} ({{ period.trang_thai }})
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" onclick="runAlgorithm()">
                üßÆ Ch·∫°y thu·∫≠t to√°n
            </button>
            <button type="button" class="btn btn-info" onclick="viewResult()">
                üìä Xem k·∫øt qu·∫£
            </button>
        </div>
    </div>
</div>

<!-- Output Console -->
<div class="card">
    <div class="card-header">
        <h5>üìä K·∫øt qu·∫£</h5>
    </div>
    <div class="card-body">
        <div id="outputConsole" style="background-color: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            ƒêang ch·ªù th·ª±c hi·ªán l·ªánh...
        </div>
    </div>
</div>

{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    /* Force vertical stacking */
    #content-main {
        display: block !important;
        width: 100% !important;
    }
    
    .card {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
        width: 100% !important;
        display: block !important;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 10px 15px;
    }
    .card-header h5 {
        margin: 0;
    }
    .card-body {
        padding: 15px;
    }
    #outputConsole {
        font-size: 12px;
        line-height: 1.4;
    }
    .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
    const apiBaseUrl = '/api/scheduling';
    
    function log(message, type = 'info') {
        const console = document.getElementById('outputConsole');
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        console.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
        console.scrollTop = console.scrollHeight;
    }
    
    function clearLog() {
        document.getElementById('outputConsole').innerHTML = '';
    }
    
    function getSelectedPeriod() {
        const select = document.getElementById('periodSelect');
        const periodId = select.value;
        if (!periodId) {
            log('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·ª£t x·∫øp!', 'error');
            return null;
        }
        return periodId;
    }
    
    function runAlgorithm() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang ch·∫°y thu·∫≠t to√°n cho ƒë·ª£t: ${periodId}...`);
        log(`‚è≥ ƒêang x·ª≠ l√Ω...`);
        
        const payload = {
            ma_dot: periodId,
            time_limit: 30,
            seed: 42
        };
        
        fetch("{% url 'sap_lich:algo_scheduler_run_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                log(`‚úÖ X·∫øp l·ªãch th√†nh c√¥ng!`, 'success');
                log(`‚è±Ô∏è Th·ªùi gian: ${data.elapsed_time.toFixed(2)}s`);
                
                if (data.ui_data) {
                    const ui = data.ui_data;
                    log(`üìä K·∫øt qu·∫£:`);
                    log(`  - T·ªïng bu·ªïi h·ªçc: ${ui.total_lectures}`);
                    log(`  - Chi ph√≠ qu√° t·∫£i ph√≤ng: ${ui.score_breakdown.room_capacity}`);
                    log(`  - Chi ph√≠ ng√†y l√†m vi·ªác: ${ui.score_breakdown.min_working_days}`);
                    log(`  - Chi ph√≠ compactness: ${ui.score_breakdown.curriculum_compactness}`);
                    log(`  - Chi ph√≠ ·ªïn ƒë·ªãnh ph√≤ng: ${ui.score_breakdown.room_stability}`);
                    log(`  - T·ªïng chi ph√≠: ${ui.score_breakdown.total}`);
                    
                    if (ui.schedule_items.length > 0) {
                        log(`Xem tr∆∞·ªõc 10 item ƒë·∫ßu:`);
                        ui.schedule_items.forEach((item, idx) => {
                            log(`  ${idx+1}. ${item.course_id} | GV: ${item.teacher} | Ph√≤ng: ${item.room} | Ng√†y ${item.day}, Ca ${item.slot}`);
                        });
                    }
                }
                
                if (data.save_result) {
                    log(`üíæ ƒê√£ l∆∞u ${data.save_result.created_count} bu·ªïi h·ªçc v√†o DB`);
                }
            } else {
                log(`‚ùå L·ªói: ${data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
            }
        })
        .catch(error => {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        });
    }
    
    function viewResult() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang xem k·∫øt qu·∫£ cho ƒë·ª£t: ${periodId}...`);
        log(`‚ÑπÔ∏è Ch·∫°y "Ch·∫°y thu·∫≠t to√°n" ƒë·ªÉ t·∫°o k·∫øt qu·∫£`);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
