{% extends "admin/base.html" %}
{% load static i18n %}

{% block title %}{{ title }} {% endblock %}

{% block breadcrumbs %}
<div class="col-12 col-md-auto d-flex flex-grow-1 align-items-center">
    <h1 class="h4 m-0 pr-3 mr-3 border-right">{{ title }}</h1>
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/">Trang ch·ªß</a></li>
        <li class="breadcrumb-item"><a href="/admin/sap_lich/algo-scheduler/">S·∫Øp l·ªãch</a></li>
        <li class="breadcrumb-item active">{{ title }}</li>
    </ol>
</div>
{% endblock %}


{% block content %}
<div id="content-main" style="padding: 20px;">

<!-- Control Panel -->
<div class="card mb-4">
    <div class="card-header">
        <h5>‚öôÔ∏è B·∫£ng ƒëi·ªÅu khi·ªÉn</h5>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label for="periodSelect">Ch·ªçn ƒë·ª£t x·∫øp:</label>
            <select id="periodSelect" class="form-control">
                <option value="">-- Ch·ªçn ƒë·ª£t --</option>
                {% for period in periods %}
                <option value="{{ period.ma_dot }}">
                    {{ period.ma_dot }} - {{ period.ten_dot }} ({{ period.trang_thai }})
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Algorithm Parameters -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="strategySelect">Chi·∫øn l∆∞·ª£c (Strategy):</label>
                    <select id="strategySelect" class="form-control">
                        <option value="TS">Tabu Search (TS) - Khuy·∫øn kh√≠ch</option>
                        <option value="SA">Simulated Annealing (SA)</option>
                    </select>
                    <small class="form-text text-muted">TS: T·ªët h∆°n cho t√¨m optimum to√†n c·ª•c | SA: T·ªët cho tho√°t kh·ªèi local optima</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="initMethodSelect">Ph∆∞∆°ng ph√°p kh·ªüi t·∫°o (Init Method):</label>
                    <select id="initMethodSelect" class="form-control">
                        <option value="greedy-cprop">Greedy CPROP - Khuy·∫øn kh√≠ch</option>
                        <option value="random-repair">Random Repair</option>
                    </select>
                    <small class="form-text text-muted">Greedy: Gi·∫£i ph√°p ban ƒë·∫ßu t·ªët h∆°n | Random: ƒêa d·∫°ng h∆°n</small>
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="timeLimitInput">Th·ªùi gian t·ªëi ƒëa (gi√¢y):</label>
                    <input type="number" id="timeLimitInput" class="form-control" value="180" min="30" max="600" step="30">
                    <small class="form-text text-muted">30-180s: nhanh | 180-300s: c√¢n b·∫±ng | 300s+: chi ti·∫øt</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="seedInput">Seed (t√πy ch·ªçn):</label>
                    <input type="number" id="seedInput" class="form-control" value="42" placeholder="ƒë·ªÉ tr·ªëng ƒë·ªÉ random">
                    <small class="form-text text-muted">Seed c·ª• th·ªÉ ƒë·ªÉ k·∫øt qu·∫£ l·∫∑p l·∫°i</small>
                </div>
            </div>
        </div>
        
        <div class="form-check mb-3">
            <input type="checkbox" id="saveToDbCheck" class="form-check-input" checked>
            <label class="form-check-label" for="saveToDbCheck">
                L∆∞u k·∫øt qu·∫£ v√†o database (ThoiKhoaBieu)
            </label>
        </div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" onclick="runAlgorithm()">
                üßÆ Ch·∫°y thu·∫≠t to√°n V2 (Fixed)
            </button>
            <button type="button" class="btn btn-info" onclick="viewResult()">
                üìä Xem k·∫øt qu·∫£
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearLog()">
                üóëÔ∏è X√≥a log
            </button>
        </div>
    </div>
</div>

<!-- Output Console -->
<div class="card">
    <div class="card-header">
        <h5>üìä K·∫øt qu·∫£</h5>
    </div>
    <div class="card-body">
        <div id="outputConsole" style="background-color: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            ƒêang ch·ªù th·ª±c hi·ªán l·ªánh...
        </div>
    </div>
</div>

{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    /* Force vertical stacking */
    #content-main {
        display: block !important;
        width: 100% !important;
    }
    
    .card {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
        width: 100% !important;
        display: block !important;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 10px 15px;
    }
    .card-header h5 {
        margin: 0;
    }
    .card-body {
        padding: 15px;
    }
    #outputConsole {
        font-size: 12px;
        line-height: 1.4;
    }
    .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
    const apiBaseUrl = '/api/scheduling';
    
    function log(message, type = 'info') {
        const console = document.getElementById('outputConsole');
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        console.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
        console.scrollTop = console.scrollHeight;
    }
    
    function clearLog() {
        document.getElementById('outputConsole').innerHTML = '';
    }
    
    function getSelectedPeriod() {
        const select = document.getElementById('periodSelect');
        const periodId = select.value;
        if (!periodId) {
            log('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·ª£t x·∫øp!', 'error');
            return null;
        }
        return periodId;
    }
    
    function runAlgorithm() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        const strategy = document.getElementById('strategySelect').value;
        const initMethod = document.getElementById('initMethodSelect').value;
        const timeLimit = parseFloat(document.getElementById('timeLimitInput').value) || 180;
        const seed = document.getElementById('seedInput').value ? parseInt(document.getElementById('seedInput').value) : 42;
        const saveToDb = document.getElementById('saveToDbCheck').checked;
        
        log(`üöÄ B·∫Øt ƒë·∫ßu x·∫øp l·ªãch cho ƒë·ª£t: ${periodId}`);
        log(`‚öôÔ∏è Tham s·ªë: Strategy=${strategy}, Init=${initMethod}, Time=${timeLimit}s, Seed=${seed}`);
        log(`‚è≥ ƒêang x·ª≠ l√Ω...`);
        
        const payload = {
            ma_dot: periodId,
            strategy: strategy,
            init_method: initMethod,
            time_limit: timeLimit,
            seed: seed,
            save_to_db: saveToDb
        };
        
        fetch("{% url 'sap_lich:algo_scheduler_run_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                log(`‚úÖ X·∫øp l·ªãch th√†nh c√¥ng!`, 'success');
                log(`‚è±Ô∏è Th·ªùi gian: ${data.time_elapsed.toFixed(2)}s`);
                log(`üìà Cost: ${data.initial_cost} ‚Üí ${data.final_cost} (C·∫£i thi·ªán: ${data.improvement_percent.toFixed(1)}%)`);
                
                // Cost breakdown
                log(`üìä Chi ti·∫øt cost:`);
                const breakdown = data.breakdown;
                log(`  - Qu√° t·∫£i ph√≤ng: ${breakdown.room_capacity}`);
                log(`  - Ng√†y l√†m vi·ªác t·ªëi thi·ªÉu: ${breakdown.min_working_days}`);
                log(`  - Compactness: ${breakdown.curriculum_compactness}`);
                log(`  - Li√™n ti·∫øp bu·ªïi h·ªçc: ${breakdown.lecture_consecutiveness}`);
                log(`  - ·ªîn ƒë·ªãnh ph√≤ng: ${breakdown.room_stability}`);
                log(`  - ∆Øu ti√™n gi√°o vi√™n: ${breakdown.teacher_preferences}`);
                log(`  - T·ªïng: ${data.final_cost}`);
                
                if (data.saved_to_db) {
                    log(`üíæ ƒê√£ l∆∞u ${data.details.lectures_scheduled} bu·ªïi h·ªçc v√†o database`, 'success');
                } else {
                    log(`‚ö†Ô∏è L∆∞u v√†o database th·∫•t b·∫°i ho·∫∑c b·ªã t·∫Øt`, 'error');
                }
                
                log(`ÔøΩ File solution: ${data.sol_file}`);
            } else {
                log(`‚ùå L·ªói: ${data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
            }
        })
        .catch(error => {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        });
    }
    
    function viewResult() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang xem k·∫øt qu·∫£ cho ƒë·ª£t: ${periodId}...`);
        log(`‚ÑπÔ∏è Ch·∫°y "Ch·∫°y thu·∫≠t to√°n" ƒë·ªÉ t·∫°o k·∫øt qu·∫£`);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
