{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}Qu·∫£n l√Ω Th·ªùi Kho√° Bi·ªÉu{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/tkb_admin.css' %}">
<script src="{% static 'js/tkb_admin.js' %}"></script>
{% endblock %}

{% block content %}
<div class="tkb-wrapper">
    <!-- Message Container (Fixed Position) -->
    <div id="tkb-message-container"></div>

    <!-- Top Section: Header + Deleted List (3:1 ratio) -->
    <div class="row g-3">
        <!-- Left: Header Section (75%) -->
        <div class="col-lg-9 d-flex">
            <div class="tkb-card flex-fill">
                <div class="d-flex flex-wrap justify-content-between gap-3 align-items-start mb-3">
                    <div class="flex-grow-1">
                        <h2 class="mb-2">Qu·∫£n l√Ω Th·ªùi Kho√° Bi·ªÉu</h2>
                        <div class="tkb-legend">
                            <span><span class="dot" style="background:#eef2ff;border-color:#c7d2fe;"></span>√î tr·ªëng c√≥ th·ªÉ th√™m</span>
                            <span><span class="dot" style="background:#dbeafe;border-color:#7dd3fc;"></span>L·ªãch ƒëang xem</span>
                            <span><span class="dot" style="background:#fee2e2;border-color:#fca5a5;"></span>L·ªãch ƒë√£ x√≥a</span>
                        </div>
                    </div>
                    <div id="tkb-selection-pill" class="badge-soft info" style="display:none; align-self: center;"></div>
                </div>

                <!-- Filter Bar -->
                <div class="mb-4">
                    <div class="tkb-label mb-3">B·ªô l·ªçc</div>
                    <div class="tkb-filter-row">
                        <div>
                            <label class="tkb-label">ƒê·ª£t x·∫øp l·ªãch</label>
                            <select id="dotSelect" class="tkb-select" onchange="tkbPage.updateFilters()">
                                <option value="">-- Ch·ªçn ƒë·ª£t --</option>
                                {% for dot in dots %}
                                    <option value="{{ dot.ma_dot }}" {% if dot.ma_dot == ma_dot %}selected{% endif %}>{{ dot.ten_dot }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="tkb-label">Khoa</label>
                            <select id="khoaSelect" class="tkb-select" onchange="tkbPage.updateFilters()">
                                <option value="">-- T·∫•t c·∫£ khoa --</option>
                                {% for khoa in khoa_list %}
                                    <option value="{{ khoa.ma_khoa }}" {% if khoa.ma_khoa == ma_khoa %}selected{% endif %}>{{ khoa.ten_khoa }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="tkb-label">Xem theo</label>
                            <select id="viewTypeSelect" class="tkb-select" onchange="tkbPage.handleViewTypeChange()">
                                <option value="teacher" {% if view_type == 'teacher' or not view_type %}selected{% endif %}>Gi√°o vi√™n</option>
                                <option value="room" {% if view_type == 'room' %}selected{% endif %}>Ph√≤ng h·ªçc</option>
                            </select>
                        </div>
                        <div id="teacherSelectGroup" {% if view_type == 'room' %}style="display:none;"{% endif %}>
                            <label class="tkb-label">Gi√°o vi√™n</label>
                            <select id="teacherSelect" class="tkb-select" onchange="tkbPage.updateFilters()">
                                <option value="">-- Ch·ªçn gi√°o vi√™n --</option>
                                {% for gv in teachers %}
                                    <option value="{{ gv.ma_gv }}" {% if gv.ma_gv == selected_id %}selected{% endif %}>{{ gv.ma_gv }} - {{ gv.ten_gv }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="roomSelectGroup" {% if view_type != 'room' %}style="display:none;"{% endif %}>
                            <label class="tkb-label">Ph√≤ng h·ªçc</label>
                            <select id="roomSelect" class="tkb-select" onchange="tkbPage.updateFilters()">
                                <option value="">-- Ch·ªçn ph√≤ng --</option>
                                {% for phong in phongs %}
                                    <option value="{{ phong.ma_phong }}" {% if phong.ma_phong == selected_id %}selected{% endif %}>{{ phong.ma_phong }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 pb-2" style="border-top: 1px solid var(--tkb-border); padding-top: 16px;">
                    <div class="tkb-action-bar">
                        <button id="btnAdd" class="tkb-btn tkb-btn-primary" type="button" title="Th√™m l·ªãch m·ªõi">
                            <span>‚ûï</span> Th√™m m·ªõi
                        </button>
                        <button id="btnEdit" class="tkb-btn tkb-btn-success" type="button" disabled title="S·ª≠a l·ªãch">
                            <span>‚úèÔ∏è</span> S·ª≠a
                        </button>
                        <button id="btnSwap" class="tkb-btn tkb-btn-warning" type="button" disabled title="Ho√°n ƒë·ªïi 2 l·ªãch">
                            <span>‚áÑ</span> Ho√°n ƒë·ªïi
                        </button>
                        <button id="btnDelete" class="tkb-btn tkb-btn-danger" type="button" disabled title="X√≥a l·ªãch">
                            <span>üóëÔ∏è</span> X√≥a
                        </button>
                        <button id="btnRestore" class="tkb-btn tkb-btn-ghost" type="button" disabled title="Ph·ª•c h·ªìi l·ªãch">
                            <span>‚Ü©Ô∏è</span> Ph·ª•c h·ªìi
                        </button>
                    </div>
                    <div class="form-text-muted">
                        <span id="action-hint">Ch·ªçn l·ªãch ƒë·ªÉ S·ª≠a/X√≥a, ch·ªçn 2 l·ªãch ƒë·ªÉ Ho√°n ƒë·ªïi</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Deleted Schedule List (25%) -->
        <div class="col-lg-3 d-flex">
            <div class="tkb-card flex-fill d-flex flex-column">
                <div class="d-flex align-items-center justify-content-between mb-3" style="border-bottom: 1px solid var(--tkb-border); padding-bottom: 12px;">
                    <h2 class="mb-0">üóëÔ∏è L·ªãch ƒë√£ x√≥a</h2>
                    <span class="badge-soft" id="deleted-count" style="background:#fee2e2;color:#991b1b;">0</span>
                </div>
                <div style="margin-bottom: 12px;">
                    <input type="text" id="deleted-search" class="form-control form-control-sm" placeholder="üîç T√¨m l·ªõp, gi√°o vi√™n..." onkeyup="renderDeleted()">
                </div>
                <div class="deleted-list" id="deleted-list" style="flex: 1; overflow-y: auto; max-height: 280px;"></div>
            </div>
        </div>
    </div>

    <!-- Main Content: Current Schedule (Full Width) -->
    <div class="row g-3">
        <div class="col-12">
            <div class="tkb-card schedule-card">
                <div class="d-flex align-items-center justify-content-between mb-3" style="border-bottom: 1px solid var(--tkb-border); padding-bottom: 12px;">
                    <h2 class="mb-0">üìÖ L·ªãch hi·ªán t·∫°i</h2>
                    <div class="form-text-muted" id="schedule-meta">0 l·ªãch</div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width:50px;">Ca</th>
                                <th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th><th>CN</th>
                            </tr>
                        </thead>
                        <tbody id="mini-schedule-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-backdrop" id="globalLoading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Modals Container (will be moved to body by tkb_admin.js) -->

<!-- Add Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" role="dialog" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScheduleModalLabel">Th√™m l·ªãch</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addScheduleForm" class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="tkb-label">ƒê·ª£t x·∫øp l·ªãch *</label>
                        <select class="form-select" name="ma_dot" id="add-ma-dot" required>
                            <option value="">-- Ch·ªçn ƒë·ª£t --</option>
                            {% for dot in dots %}
                                <option value="{{ dot.ma_dot }}" {% if dot.ma_dot == ma_dot %}selected{% endif %}>{{ dot.ten_dot }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="tkb-label">Gi√°o vi√™n *</label>
                        <select class="form-select" name="ma_gv" id="add-gv" required>
                            <option value="">-- Ch·ªçn gi√°o vi√™n --</option>
                            {% for gv in teachers %}
                                <option value="{{ gv.ma_gv }}">{{ gv.ma_gv }} - {{ gv.ten_gv }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="tkb-label">M√¥n h·ªçc *</label>
                        <select class="form-select" name="ma_mon_hoc" id="add-mon-hoc" required>
                            <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                            {% for mon in mon_hoc_list %}
                                <option value="{{ mon.ma_mon_hoc }}">{{ mon.ma_mon_hoc }} - {{ mon.ten_mon_hoc }}</option>
                            {% endfor %}
                        </select>
                        <div id="add-mon-hoc-info" class="mt-2" style="display:none;">
                            <div id="add-mon-hoc-details" class="form-text-muted"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="tkb-label">Nh√≥m *</label>
                        <select class="form-select" name="nhom_mh" id="add-nhom" required>
                            <option value="">-- Ch·ªçn nh√≥m --</option>
                            {% for i in "12345678910" %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                            {% endfor %}
                        </select>
                        <div id="add-nhom-hint" class="form-text-muted"></div>
                    </div>
                    <div class="col-md-4">
                        <label class="tkb-label">T·ªï *</label>
                        <select class="form-select" name="to_mh" id="add-to" required>
                            <option value="0">0 (LT)</option>
                            <option value="1">1 (TH)</option>
                            <option value="2">2 (TH)</option>
                        </select>
                        <div id="add-to-hint" class="form-text-muted"></div>
                    </div>
                    <div class="col-md-4">
                        <label class="tkb-label">S·ªë SV</label>
                        <input type="number" min="1" class="form-control" name="so_luong_sv" id="add-soluongsv" value="40">
                    </div>
                    <div class="col-md-6">
                        <label class="tkb-label">Ph√≤ng h·ªçc *</label>
                        <select class="form-select" name="ma_phong" id="add-phong" required>
                            <option value="">-- Ch·ªçn ph√≤ng --</option>
                            {% for phong in phongs %}
                                <option value="{{ phong.ma_phong }}" data-loai="{{ phong.loai_phong|default:'' }}">{{ phong.ma_phong }} ({{ phong.suc_chua }} ch·ªó){% if phong.loai_phong %} - {{ phong.loai_phong }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="tkb-label">Th·ªùi gian *</label>
                        <select class="form-select" name="time_slot_id" id="add-timeslot" required>
                            <option value="">-- Ch·ªçn th·ªùi gian --</option>
                            {% for ts in timeslots %}
                                <option value="{{ ts.time_slot_id }}">{% if ts.thu == 2 %}Th·ª© 2{% elif ts.thu == 3 %}Th·ª© 3{% elif ts.thu == 4 %}Th·ª© 4{% elif ts.thu == 5 %}Th·ª© 5{% elif ts.thu == 6 %}Th·ª© 6{% elif ts.thu == 7 %}Th·ª© 7{% elif ts.thu == 8 %}CN{% endif %} - Ca {{ ts.ca.ma_khung_gio }} ({{ ts.ca.gio_bat_dau|time:"H:i" }}-{{ ts.ca.gio_ket_thuc|time:"H:i" }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-danger d-none" id="add-gv-busy-hint"></div>
                    </div>
                    <div class="col-md-12">
                        <label class="tkb-label">Tu·∫ßn h·ªçc</label>
                        <input type="text" class="form-control" name="tuan_hoc" id="add-tuan" placeholder="VD: 1,2,3-5,7">
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">H·ªßy</button>
                <button type="submit" form="addScheduleForm" class="btn btn-primary" id="btnAddSubmit">Th√™m l·ªãch</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" role="dialog" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScheduleModalLabel">S·ª≠a l·ªãch</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editScheduleForm" class="modal-body">
                <input type="hidden" name="ma_tkb" id="edit-ma-tkb">
                <input type="hidden" id="edit-ma-lop-current">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="tkb-label">L·ªõp hi·ªán t·∫°i</label>
                        <input type="text" class="form-control" id="edit-lop-display" readonly>
                    </div>
                    <div class="col-md-12">
                        <label class="tkb-label">M√¥n h·ªçc</label>
                        <select class="form-select" name="ma_mon_hoc" id="edit-mon-hoc">
                            <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                            {% for mon in mon_hoc_list %}
                                <option value="{{ mon.ma_mon_hoc }}">{{ mon.ten_mon_hoc }} ({{ mon.ma_mon_hoc }})</option>
                            {% endfor %}
                        </select>
                        <div id="edit-mon-hoc-info" class="mt-2" style="display:none;"><div id="edit-mon-hoc-details" class="form-text-muted"></div></div>
                    </div>
                    <div class="col-md-4">
                        <label class="tkb-label">Nh√≥m</label>
                        <select class="form-select" name="nhom" id="edit-nhom">
                            {% for i in "12345678910" %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="tkb-label">T·ªï</label>
                        <select class="form-select" name="to" id="edit-to">
                            <option value="0">0 (LT)</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="tkb-label">S·ªë SV</label>
                        <input type="number" min="1" class="form-control" name="so_luong_sv" id="edit-soluongsv" required>
                    </div>
                    <div class="col-md-6">
                        <label class="tkb-label">Ph√≤ng h·ªçc</label>
                        <select class="form-select" name="ma_phong" id="edit-phong">
                            <option value="">-- Ch·ªçn ph√≤ng --</option>
                            {% for phong in phongs %}
                                <option value="{{ phong.ma_phong }}" data-loai="{{ phong.loai_phong }}" data-suc-chua="{{ phong.suc_chua }}">{{ phong.ma_phong }} ({{ phong.suc_chua }} ch·ªó)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="tkb-label">Th·ªùi gian</label>
                        <select class="form-select" name="time_slot_id" id="edit-timeslot">
                            <option value="">-- Ch·ªçn th·ªùi gian --</option>
                            {% for ts in timeslots %}
                                <option value="{{ ts.time_slot_id }}">{% if ts.thu == 2 %}Th·ª© 2{% elif ts.thu == 3 %}Th·ª© 3{% elif ts.thu == 4 %}Th·ª© 4{% elif ts.thu == 5 %}Th·ª© 5{% elif ts.thu == 6 %}Th·ª© 6{% elif ts.thu == 7 %}Th·ª© 7{% elif ts.thu == 8 %}CN{% endif %} - Ca {{ ts.ca.ma_khung_gio }} ({{ ts.ca.gio_bat_dau|time:"H:i" }}-{{ ts.ca.gio_ket_thuc|time:"H:i" }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-danger d-none" id="edit-gv-busy-hint"></div>
                    </div>
                    <div class="col-md-12">
                        <label class="tkb-label">Tu·∫ßn h·ªçc</label>
                        <input type="text" class="form-control" name="tuan_hoc" id="edit-tuan" placeholder="VD: 1-8,10-15">
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">H·ªßy</button>
                <button type="submit" form="editScheduleForm" class="btn btn-success" id="btnEditSubmit">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">X√°c nh·∫≠n x√≥a</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-1">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch n√†y?</p>
                <div class="form-text-muted" id="delete-summary"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="btnDeleteConfirm">X√≥a</button>
            </div>
        </div>
    </div>
</div>

<!-- Swap Modal -->
<div class="modal fade" id="swapScheduleModal" tabindex="-1" role="dialog" aria-labelledby="swapScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="swapScheduleModalLabel">Ho√°n ƒë·ªïi l·ªãch</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-2">
                    <div class="col-md-6">
                        <label class="tkb-label">L·ªãch A</label>
                        <select class="form-select" id="swap-select-a"></select>
                        <div class="form-text-muted" id="swap-a-info"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="tkb-label">L·ªãch B</label>
                        <select class="form-select" id="swap-select-b"></select>
                        <div class="form-text-muted" id="swap-b-info"></div>
                    </div>
                    <div class="col-md-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="swap-phong" checked>
                            <label class="form-check-label" for="swap-phong">Ho√°n ƒë·ªïi c·∫£ ph√≤ng h·ªçc</label>
                        </div>
                        <div class="form-text-muted">B·∫≠t: ƒë·ªïi c·∫£ ph√≤ng v√† timeslot. T·∫Øt: ch·ªâ ƒë·ªïi timeslot, gi·ªØ nguy√™n ph√≤ng (backend s·∫Ω ki·ªÉm tra tr√πng).</div>
                    </div>
                </div>
                <div id="swap-warning" class="alert alert-warning d-none mb-0" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-warning" id="btnSwapSubmit" disabled>Ho√°n ƒë·ªïi</button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Modal -->
<div class="modal fade" id="restoreScheduleModal" tabindex="-1" role="dialog" aria-labelledby="restoreScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreScheduleModalLabel">Ph·ª•c h·ªìi l·ªãch - ch·ªçn ph√≤ng kh·∫£ d·ª•ng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="restoreScheduleForm" class="modal-body">
                <input type="hidden" id="restore-ma-tkb" name="ma_tkb">
                <input type="hidden" id="restore-soluongsv" value="0">
                <div class="mb-3" id="restore-info" aria-live="polite"></div>
                <div class="alert alert-info" id="restore-hint" role="alert"></div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="tkb-label">Th·ªùi gian</label>
                        <select class="form-select" id="restore-timeslot" disabled>
                            <option value="">-- Th·ªùi gian --</option>
                            {% for ts in timeslots %}
                                <option value="{{ ts.time_slot_id }}">{% if ts.thu == 2 %}Th·ª© 2{% elif ts.thu == 3 %}Th·ª© 3{% elif ts.thu == 4 %}Th·ª© 4{% elif ts.thu == 5 %}Th·ª© 5{% elif ts.thu == 6 %}Th·ª© 6{% elif ts.thu == 7 %}Th·ª© 7{% elif ts.thu == 8 %}CN{% endif %} - Ca {{ ts.ca.ma_khung_gio }} ({{ ts.ca.gio_bat_dau|time:"H:i" }}-{{ ts.ca.gio_ket_thuc|time:"H:i" }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="tkb-label">Ch·ªçn ph√≤ng thay th·∫ø</label>
                        <select class="form-select" id="restore-phong">
                            <option value="">-- Ch·ªçn ph√≤ng --</option>
                            {% for phong in phongs %}
                                <option value="{{ phong.ma_phong }}" data-loai="{{ phong.loai_phong|default:'' }}">{{ phong.ma_phong }} ({{ phong.suc_chua }} ch·ªó){% if phong.loai_phong %} - {{ phong.loai_phong }}{% endif %}</option>
                            {% endfor %}
                        </select>
                        <div id="restore-phong-hint" class="form-text-muted mt-1"></div>
                    </div>
                </div>
                <div class="alert alert-warning mt-3 d-none" id="restore-warning" role="alert"></div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" id="btnRestoreSubmit">Ph·ª•c h·ªìi</button>
            </div>
        </div>
    </div>
</div>

<!-- Trash Zone for Drag & Drop Delete -->
<div id="trash-zone" class="trash-zone">
    <div class="trash-icon">üóëÔ∏è</div>
    <div class="trash-text">K√©o v√†o ƒë√¢y ƒë·ªÉ x√≥a</div>
</div>

<script>
    (function() {
        // ==================================================
        // PH·∫¶N A: FIX MODAL LAYERING - Proper z-index & stacking
        // ==================================================
        // Fix stacking context: ensure modals render above backdrop
        // Don't move modals to body - keep them in place but with proper z-index
        function fixModalStacking() {
            const modalIds = ['addScheduleModal', 'editScheduleModal', 'deleteConfirmModal', 'swapScheduleModal', 'restoreScheduleModal'];
            modalIds.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    // Set modal z-index higher than default
                    modal.style.zIndex = '1050';
                }
            });
        }

        const $ = window.django?.jQuery || window.jQuery;
        if (!$) {
            console.warn('jQuery not available yet, will initialize on DOMContentLoaded');
        }

        const tkbPermissions = Object.assign({
            can_create: true,
            can_edit: true,
            can_delete: true,
            can_restore: true,
            can_swap: true,
            role: "{{ user_role|default_if_none:'' }}"
        }, JSON.parse('{{ tkb_permissions|default:'{}'|escapejs }}'));

        const api = Object.assign({
            mini: "/api/tkb/mini-schedule/",
            create: "/api/tkb/create/",
            update: "/api/tkb/update/",
            updateTimeslot: "/api/tkb/update-timeslot/",  // Drag & drop API
            delete: "/api/tkb/delete/",
            restore: "/api/tkb/restore/",
            swap: "/api/tkb/swap/",
            monhoc: "/api/tkb/mon-hoc-info/",
            occupied: "/api/tkb/occupied-rooms/",
            gvSchedule: "/api/tkb/gv-schedule/",
            gvList: "/api/tkb/gv-list/"
        }, JSON.parse('{{ tkb_api|default:'{}'|escapejs }}'));

        const state = {
            schedule: [],
            deleted: [],
            allInDot: [],
            selected: null,
            selectedDeleted: null,
            selectedSwapA: null,
            selectedSwapB: null,
            lastEmptySlot: null,
            restoreContext: null,
        };

        function getPageContext() {
            return {
                ma_dot: document.getElementById('dotSelect').value || document.getElementById('add-ma-dot').value,
                view_type: document.getElementById('viewTypeSelect').value || 'teacher',
                ma_gv: document.getElementById('teacherSelect').value,
                ma_phong: document.getElementById('roomSelect').value
            };
        }

        function applyContextToAddModal({ lockTimeslot = false } = {}) {
            const ctx = getPageContext();
            const maDotEl = document.getElementById('add-ma-dot');
            const gvEl = document.getElementById('add-gv');
            const roomEl = document.getElementById('add-phong');
            const timeslotEl = document.getElementById('add-timeslot');

            if (maDotEl) {
                maDotEl.value = ctx.ma_dot || maDotEl.value || '';
                maDotEl.disabled = Boolean(ctx.ma_dot);
            }

            if (gvEl) {
                const shouldLockGv = ctx.view_type === 'teacher' && ctx.ma_gv;
                gvEl.value = ctx.ma_gv || gvEl.value || '';
                gvEl.disabled = shouldLockGv;
            }

            if (roomEl) {
                const shouldLockRoom = ctx.view_type === 'room' && ctx.ma_phong;
                roomEl.value = ctx.ma_phong || roomEl.value || '';
                roomEl.disabled = shouldLockRoom;
            }

            if (timeslotEl && !lockTimeslot) {
                timeslotEl.disabled = false;
            }
        }

        const els = {
            message: document.getElementById('tkb-message-container'),
            miniBody: document.getElementById('mini-schedule-body'),
            deletedList: document.getElementById('deleted-list'),
            deletedCount: document.getElementById('deleted-count'),
            selectionPill: document.getElementById('tkb-selection-pill'),
            scheduleMeta: document.getElementById('schedule-meta'),
            buttons: {
                add: document.getElementById('btnAdd'),
                edit: document.getElementById('btnEdit'),
                del: document.getElementById('btnDelete'),
                restore: document.getElementById('btnRestore'),
                swap: document.getElementById('btnSwap'),
            },
            loading: document.getElementById('globalLoading'),
        };

        let modals = {};

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function showMessage(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            els.message.appendChild(div);
            setTimeout(() => div.remove(), 4500);
        }

        function setLoading(on) {
            els.loading.classList.toggle('active', on);
        }

        function updateActionState() {
            const hasSelection = Boolean(state.selected);
            const canCreate = tkbPermissions.can_create !== false;
            const canEdit = tkbPermissions.can_edit !== false && hasSelection;
            const canDelete = tkbPermissions.can_delete !== false && hasSelection;
            const canSwap = tkbPermissions.can_swap !== false && (state.selectedSwapA || state.selectedSwapB || state.selected);
            const canRestore = tkbPermissions.can_restore !== false && state.selectedDeleted;

            // Update button states v·ªõi tooltip
            els.buttons.add.disabled = !canCreate;
            TKB.updateButtonState(els.buttons.add, canCreate);
            
            els.buttons.edit.disabled = !canEdit;
            TKB.updateButtonState(els.buttons.edit, canEdit, canEdit ? '' : 'Vui l√≤ng ch·ªçn 1 l·ªãch ƒë·ªÉ s·ª≠a');
            TKB.highlightClassChip(document.querySelector('.class-chip.selected'), hasSelection);
            
            els.buttons.del.disabled = !canDelete;
            TKB.updateButtonState(els.buttons.del, canDelete, canDelete ? '' : 'Vui l√≤ng ch·ªçn 1 l·ªãch ƒë·ªÉ x√≥a');
            
            els.buttons.swap.disabled = !canSwap;
            TKB.updateButtonState(els.buttons.swap, canSwap, canSwap ? '' : 'Vui l√≤ng ch·ªçn 2 l·ªãch ƒë·ªÉ ho√°n ƒë·ªïi');
            
            els.buttons.restore.disabled = !canRestore;
            TKB.updateButtonState(els.buttons.restore, canRestore, canRestore ? '' : 'Vui l√≤ng ch·ªçn 1 l·ªãch ƒë√£ x√≥a ƒë·ªÉ ph·ª•c h·ªìi');

            // Update selection pill
            if (state.selected) {
                els.selectionPill.style.display = 'inline-block';
                els.selectionPill.textContent = `${state.selected.mon_hoc || state.selected.ma_lop} | ${state.selected.ma_phong || 'Ph√≤ng ?'} | Th·ª© ${state.selected.thu} - Ca ${state.selected.ca}`;
            } else {
                els.selectionPill.style.display = 'none';
            }
        }

        function fetchJSON(url, options = {}) {
            const headers = options.headers || {};
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes((options.method || '').toUpperCase())) {
                headers['X-CSRFToken'] = getCookie('csrftoken');
                headers['Content-Type'] = headers['Content-Type'] || 'application/json';
            }
            return fetch(url, { ...options, headers });
        }

        function buildQuery() {
            const params = new URLSearchParams();
            const ma_dot = document.getElementById('dotSelect').value;
            const ma_khoa = document.getElementById('khoaSelect').value;
            const view_type = document.getElementById('viewTypeSelect').value;
            let selected_id = '';
            if (view_type === 'teacher') selected_id = document.getElementById('teacherSelect').value;
            if (view_type === 'room') selected_id = document.getElementById('roomSelect').value;
            if (ma_dot) params.set('ma_dot', ma_dot);
            if (ma_khoa) params.set('ma_khoa', ma_khoa);
            if (view_type) params.set('view_type', view_type);
            if (selected_id) params.set('selected_id', selected_id);
            return params.toString();
        }

        function updateFilters() {
            const q = buildQuery();
            window.location.href = q ? `?${q}` : window.location.pathname;
        }

        function handleViewTypeChange() {
            const view_type = document.getElementById('viewTypeSelect').value;
            document.getElementById('teacherSelectGroup').style.display = view_type === 'teacher' ? 'block' : 'none';
            document.getElementById('roomSelectGroup').style.display = view_type === 'room' ? 'block' : 'none';
            if (view_type !== 'teacher') document.getElementById('teacherSelect').value = '';
            if (view_type !== 'room') document.getElementById('roomSelect').value = '';
            updateFilters();
        }

        async function loadSchedule() {
            try {
                setLoading(true);
                const query = buildQuery();
                const res = await fetchJSON(`${api.mini}?${query}`);
                const data = await res.json();
                state.schedule = data.schedule || [];
                state.deleted = data.deleted || [];
                els.scheduleMeta.textContent = `${state.schedule.length} l·ªãch`;
                renderSchedule();
                renderDeleted();
                state.selected = null;
                state.selectedDeleted = null;
                state.selectedSwapA = null;
                state.selectedSwapB = null;
                updateActionState();
                fillSwapSelects();
            } catch (e) {
                console.error(e);
                showMessage('error', 'L·ªói t·∫£i l·ªãch: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        // ===== DRAG & DROP HANDLERS =====
        let dragState = {
            draggedElement: null,
            draggedData: null
        };

        function handleDragStart(e) {
            dragState.draggedElement = e.target;
            dragState.draggedData = {
                ma_tkb: e.target.dataset.maTkb,
                thu: parseInt(e.target.dataset.thu),
                ca: parseInt(e.target.dataset.ca),
                mon_hoc: e.target.dataset.monHoc || e.target.dataset.maLop,
                ma_lop: e.target.dataset.maLop
            };
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', dragState.draggedData.ma_tkb);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            
            // X√≥a t·∫•t c·∫£ highlight
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function makeCellDroppable(cell) {
            cell.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                cell.classList.add('drag-over');
            });

            cell.addEventListener('dragleave', (e) => {
                cell.classList.remove('drag-over');
            });

            cell.addEventListener('drop', async (e) => {
                e.preventDefault();
                cell.classList.remove('drag-over');
                
                const targetThu = parseInt(cell.dataset.thu);
                const targetCa = parseInt(cell.dataset.ca);
                
                if (!dragState.draggedData) return;
                
                // Ki·ªÉm tra xem c√≥ thay ƒë·ªïi kh√¥ng
                if (dragState.draggedData.thu === targetThu && dragState.draggedData.ca === targetCa) {
                    return; // Kh√¥ng thay ƒë·ªïi v·ªã tr√≠
                }
                
                // Confirm tr∆∞·ªõc khi di chuy·ªÉn
                const oldSlot = `Th·ª© ${dragState.draggedData.thu}, Ca ${dragState.draggedData.ca}`;
                const newSlot = `Th·ª© ${targetThu}, Ca ${targetCa}`;
                
                if (!confirm(`Di chuy·ªÉn m√¥n h·ªçc t·ª´ ${oldSlot} sang ${newSlot}?`)) {
                    return;
                }
                
                // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t
                try {
                    setLoading(true);
                    const response = await fetchJSON(api.updateTimeslot, {
                        method: 'POST',
                        body: JSON.stringify({
                            ma_tkb: dragState.draggedData.ma_tkb,
                            thu: targetThu,
                            ca: targetCa
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        showMessage('success', result.message);
                        if (result.warnings && result.warnings.length > 0) {
                            result.warnings.forEach(w => showMessage('warning', w));
                        }
                        await loadSchedule();
                    } else {
                        showMessage('error', result.message || 'L·ªói khi di chuy·ªÉn m√¥n h·ªçc');
                        if (result.errors && result.errors.length > 0) {
                            result.errors.forEach(err => showMessage('error', err));
                        }
                    }
                } catch (error) {
                    console.error('Drag & drop error:', error);
                    showMessage('error', 'L·ªói k·∫øt n·ªëi khi di chuy·ªÉn m√¥n h·ªçc');
                } finally {
                    setLoading(false);
                    dragState.draggedElement = null;
                    dragState.draggedData = null;
                }
            });
        }

        // ===== TRASH ZONE HANDLERS =====
        function initTrashZone() {
            const trashZone = document.getElementById('trash-zone');
            if (!trashZone) return;
            
            trashZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                trashZone.classList.add('drag-over');
            });

            trashZone.addEventListener('dragleave', (e) => {
                trashZone.classList.remove('drag-over');
            });

            trashZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                trashZone.classList.remove('drag-over');
                
                if (!dragState.draggedData) return;
                
                // Confirm tr∆∞·ªõc khi x√≥a
                const classInfo = `${dragState.draggedData.mon_hoc || dragState.draggedData.ma_lop} (Th·ª© ${dragState.draggedData.thu}, Ca ${dragState.draggedData.ca})`;
                
                if (!confirm(`X√≥a m√¥n h·ªçc: ${classInfo}?`)) {
                    return;
                }
                
                // G·ªçi API ƒë·ªÉ x√≥a
                try {
                    setLoading(true);
                    const response = await fetchJSON(api.delete, {
                        method: 'POST',
                        body: JSON.stringify({
                            ma_tkb: dragState.draggedData.ma_tkb,
                            reason: 'X√≥a b·∫±ng drag & drop'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        showMessage('success', 'X√≥a m√¥n h·ªçc th√†nh c√¥ng');
                        await loadSchedule();
                    } else {
                        showMessage('error', result.message || 'L·ªói khi x√≥a m√¥n h·ªçc');
                    }
                } catch (error) {
                    console.error('Trash zone error:', error);
                    showMessage('error', 'L·ªói k·∫øt n·ªëi khi x√≥a m√¥n h·ªçc');
                } finally {
                    setLoading(false);
                    dragState.draggedElement = null;
                    dragState.draggedData = null;
                }
            });
        }

        function renderSchedule() {
            const tbody = els.miniBody;
            tbody.innerHTML = '';
            const slots = {};
            state.schedule.forEach(item => {
                let caNumber = item.ca;
                if (typeof caNumber === 'string') {
                    const match = caNumber.match(/\d+/);
                    caNumber = match ? parseInt(match[0], 10) : caNumber;
                }
                const key = `${item.thu}_${caNumber}`;
                if (!slots[key]) slots[key] = [];
                slots[key].push(item);
            });

            for (let ca = 1; ca <= 5; ca++) {
                const tr = document.createElement('tr');
                const label = document.createElement('td');
                label.textContent = ca;
                label.className = 'text-center fw-bold';
                tr.appendChild(label);
                for (let day = 2; day < 9; day++) {
                    const td = document.createElement('td');
                    td.dataset.thu = day;
                    td.dataset.ca = ca;
                    const key = `${day}_${ca}`;
                    const classes = slots[key] || [];
                    
                    // Cho ph√©p drop v√†o √¥
                    makeCellDroppable(td);
                    
                    if (classes.length === 0) {
                        td.classList.add('is-empty');
                        td.addEventListener('click', () => {
                            state.lastEmptySlot = { thu: day, ca };
                            openAddModalFromSlot();
                        });
                    } else {
                        classes.forEach(cls => {
                            const div = document.createElement('div');
                            div.className = 'class-chip' + (state.selected && state.selected.ma_tkb === cls.ma_tkb ? ' selected' : '');
                            div.innerHTML = `<div class="fw-semibold">${cls.mon_hoc || cls.ma_lop}</div><div class="class-meta"><span>${cls.ma_lop || ''}</span><span>${cls.ma_phong || 'Ph√≤ng ?'}</span><span>Th·ª© ${cls.thu} - Ca ${cls.ca}</span></div>`;
                            
                            // Th√™m drag & drop
                            div.draggable = true;
                            div.dataset.maTkb = cls.ma_tkb;
                            div.dataset.thu = cls.thu;
                            div.dataset.ca = cls.ca;
                            div.dataset.monHoc = cls.mon_hoc || cls.ma_lop;
                            div.dataset.maLop = cls.ma_lop;
                            
                            div.addEventListener('dragstart', handleDragStart);
                            div.addEventListener('dragend', handleDragEnd);
                            
                            div.addEventListener('click', (ev) => {
                                ev.stopPropagation();
                                state.selected = cls;
                                updateActionState();
                                renderSchedule();
                            });
                            td.appendChild(div);
                        });
                    }
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        function renderDeleted() {
            const list = els.deletedList;
            const searchInput = document.getElementById('deleted-search');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            // L·ªçc danh s√°ch theo t√¨m ki·∫øm
            const filtered = state.deleted.filter(item => {
                const searchText = `${item.mon_hoc} ${item.ma_lop} ${item.ten_gv || ''}`.toLowerCase();
                return searchText.includes(searchTerm);
            });
            
            list.innerHTML = '';
            els.deletedCount.textContent = `${filtered.length}/${state.deleted.length}`;
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="deleted-list-empty">' + 
                    (state.deleted.length === 0 ? '‚úì Kh√¥ng c√≥ l·ªãch ƒë√£ x√≥a' : 'üîç Kh√¥ng t√¨m th·∫•y l·ªõp') + 
                    '</div>';
                return;
            }
            
            const selectedId = state.selectedDeleted ? state.selectedDeleted.ma_tkb : null;
            filtered.forEach(item => {
                const row = document.createElement('div');
                row.className = 'deleted-row';
                if (selectedId && selectedId === item.ma_tkb) {
                    row.classList.add('selected');
                }
                
                // T·∫°o info section
                const info = document.createElement('div');
                info.className = 'deleted-row-info';
                info.innerHTML = `
                    <strong>${item.mon_hoc || item.ma_lop}</strong>
                    <div class="meta">
                        <span>${item.ma_lop || 'N/A'}</span>
                        <span>‚Ä¢</span>
                        <span>${item.ma_phong || 'Ph√≤ng ?'}</span>
                        <span>‚Ä¢</span>
                        <span>Th·ª© ${item.thu}, Ca ${item.ca}</span>
                    </div>
                    <div class="meta" style="margin-top: 4px; color: #0891b2; font-weight: 500;">
                        üë®‚Äçüè´ ${item.ten_gv || 'N/A'} (${item.ma_gv || 'N/A'})
                    </div>
                `;
                
                // T·∫°o button ph·ª•c h·ªìi
                const btnDiv = document.createElement('div');
                btnDiv.className = 'deleted-row-btn';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-outline-success';
                btn.textContent = '‚Ü©Ô∏è Ph·ª•c h·ªìi';
                btn.addEventListener('click', (ev) => { 
                    ev.stopPropagation(); 
                    startRestoreFlow(item); 
                });
                btnDiv.appendChild(btn);
                
                row.appendChild(info);
                row.appendChild(btnDiv);
                
                // Attach selection handler
                row.addEventListener('click', () => {
                    state.selectedDeleted = item;
                    renderDeleted();
                    updateActionState();
                });
                
                list.appendChild(row);
            });
        }

        function fillSwapSelects() {
            const selectA = document.getElementById('swap-select-a');
            const selectB = document.getElementById('swap-select-b');
            [selectA, selectB].forEach(sel => sel.innerHTML = '<option value="">-- Ch·ªçn l·ªãch --</option>');
            state.schedule.forEach(item => {
                const label = `${item.mon_hoc || item.ma_lop} | ${item.ma_phong || 'Ph√≤ng ?'} | Th·ª© ${item.thu} - Ca ${item.ca}`;
                const optA = document.createElement('option');
                optA.value = item.ma_tkb; optA.textContent = label;
                const optB = optA.cloneNode(true);
                selectA.appendChild(optA);
                selectB.appendChild(optB);
            });
        }

        function openAddModalFromSlot() {
            modals.add.show();
            applyContextToAddModal({ lockTimeslot: true });
            autoFillAddModal();
            const timeslot = document.getElementById('add-timeslot');
            if (timeslot) {
                timeslot.disabled = false;
            }
            if (state.lastEmptySlot && timeslot) {
                const tsId = getTimeSlotIdByThuCa(state.lastEmptySlot.thu, state.lastEmptySlot.ca);
                if (tsId) {
                    timeslot.value = tsId;
                    timeslot.disabled = true;
                    filterRoomsByTimeslot('add');
                    precheckGvAvailability('add');
                }
            }
        }

        function autoFillAddModal() {
            const gvSelect = document.getElementById('add-gv');
            const selectedGv = document.getElementById('teacherSelect').value;
            const tuanInput = document.getElementById('add-tuan');
            
            // Auto-fill gi√°o vi√™n t·ª´ filter
            if (selectedGv && gvSelect) {
                gvSelect.value = selectedGv;
            }
            
            // Auto-fill tu·∫ßn h·ªçc n·∫øu c√≥ l·ªãch ƒë∆∞·ª£c ch·ªçn
            if (state.selected && state.selected.tuan_hoc && tuanInput) {
                tuanInput.value = state.selected.tuan_hoc;
            }
        }

        function populateEditModal(tkb) {
            if (!tkb) return;
            document.getElementById('edit-ma-tkb').value = tkb.ma_tkb;
            document.getElementById('edit-ma-lop-current').value = tkb.ma_lop;
            document.getElementById('edit-lop-display').value = tkb.ma_lop;
            const parts = tkb.ma_lop.split('_');
            let ma_mon = parts.slice(0, -2).join('_');
            let nhom = parts.length >= 2 ? parts[parts.length - 2] : '';
            let to = parts.length >= 1 ? parts[parts.length - 1] : '';
            document.getElementById('edit-mon-hoc').value = ma_mon;
            document.getElementById('edit-nhom').value = nhom;
            document.getElementById('edit-to').value = to;
            document.getElementById('edit-soluongsv').value = tkb.so_luong_sv || '';
            document.getElementById('edit-phong').value = tkb.ma_phong || '';
            document.getElementById('edit-timeslot').value = tkb.time_slot_id || '';
            document.getElementById('edit-tuan').value = tkb.tuan_hoc || '';
            if (ma_mon) {
                handleEditMonHocChange();
            }
            precheckGvAvailability('edit');
        }

        function bindForms() {
            const addForm = document.getElementById('addScheduleForm');
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                
                // Validate form
                if (!TKB.validateForm(form)) {
                    showMessage('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc');
                    return;
                }
                
                const data = Object.fromEntries(new FormData(form).entries());
                const submitBtn = document.getElementById('btnAddSubmit');
                try {
                    setLoading(true);
                    TKB.setButtonLoading(submitBtn, true, 'ƒêang th√™m...');
                    const res = await fetchJSON(api.create, { method: 'POST', body: JSON.stringify(data) });
                    const result = await res.json();
                    if (result.status === 'success') {
                        modals.add.hide();
                        TKB.resetForm(form);
                        showMessage('success', result.message || 'Th√™m l·ªãch th√†nh c√¥ng');
                        await loadSchedule();
                    } else {
                        showMessage('error', result.message || 'Kh√¥ng th·ªÉ th√™m l·ªãch');
                    }
                } catch (err) {
                    showMessage('error', err.message);
                } finally { 
                    setLoading(false); 
                    TKB.setButtonLoading(submitBtn, false, 'Th√™m l·ªãch');
                }
            });

            const editForm = document.getElementById('editScheduleForm');
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                
                // Validate form
                if (!TKB.validateForm(form)) {
                    showMessage('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc');
                    return;
                }
                
                const data = Object.fromEntries(new FormData(form).entries());
                const submitBtn = document.getElementById('btnEditSubmit');
                try {
                    setLoading(true);
                    TKB.setButtonLoading(submitBtn, true, 'ƒêang l∆∞u...');
                    const res = await fetchJSON(api.update, { method: 'POST', body: JSON.stringify(data) });
                    const result = await res.json();
                    if (result.status === 'success') {
                        modals.edit.hide();
                        TKB.resetForm(form);
                        showMessage('success', result.message || 'C·∫≠p nh·∫≠t th√†nh c√¥ng');
                        await loadSchedule();
                    } else {
                        showMessage('error', result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t');
                    }
                } catch (err) {
                    showMessage('error', err.message);
                } finally { 
                    setLoading(false); 
                    TKB.setButtonLoading(submitBtn, false, 'L∆∞u');
                }
            });
        }

        async function deleteSchedule() {
            if (!state.selected) return;
            const deleteBtn = document.getElementById('btnDeleteConfirm');
            try {
                setLoading(true);
                TKB.setButtonLoading(deleteBtn, true, 'ƒêang x√≥a...');
                const res = await fetchJSON(api.delete, { method: 'POST', body: JSON.stringify({ ma_tkb: state.selected.ma_tkb }) });
                const result = await res.json();
                if (result.status === 'success') {
                    showMessage('success', result.message || 'ƒê√£ x√≥a l·ªãch');
                    await loadSchedule();
                    modals.delete.hide();
                } else {
                    showMessage('error', result.message || 'X√≥a th·∫•t b·∫°i');
                }
            } catch (err) {
                showMessage('error', err.message);
            } finally { 
                setLoading(false); 
                TKB.setButtonLoading(deleteBtn, false, 'X√≥a');
            }
        }

        async function restoreSchedule(payload) {
            try {
                setLoading(true);
                const body = typeof payload === 'string' ? { ma_tkb: payload } : payload;
                const res = await fetchJSON(api.restore, { method: 'POST', body: JSON.stringify(body) });
                const result = await res.json();
                if (result.status === 'success') {
                    showMessage('success', result.message || 'ƒê√£ ph·ª•c h·ªìi');
                    await loadSchedule();
                } else {
                    showMessage('error', result.message || 'Ph·ª•c h·ªìi th·∫•t b·∫°i');
                }
            } catch (err) {
                showMessage('error', err.message);
                throw err;
            } finally { setLoading(false); }
        }

        async function swapSchedules() {
            const ma_tkb_1 = document.getElementById('swap-select-a').value;
            const ma_tkb_2 = document.getElementById('swap-select-b').value;
            if (!ma_tkb_1 || !ma_tkb_2 || ma_tkb_1 === ma_tkb_2) {
                showMessage('warning', 'Ch·ªçn 2 l·ªãch kh√°c nhau ƒë·ªÉ ho√°n ƒë·ªïi');
                return;
            }
            const swap_phong = document.getElementById('swap-phong').checked;
            const swapBtn = document.getElementById('btnSwapSubmit');
            try {
                setLoading(true);
                swapBtn.disabled = true;
                const res = await fetchJSON(api.swap, { method: 'POST', body: JSON.stringify({ ma_tkb_1, ma_tkb_2, swap_phong }) });
                const result = await res.json();
                if (result.status === 'success') {
                    showMessage('success', result.message || 'ƒê√£ ho√°n ƒë·ªïi');
                    modals.swap.hide();
                    await loadSchedule();
                } else {
                    showMessage('error', result.message || 'Ho√°n ƒë·ªïi th·∫•t b·∫°i');
                }
            } catch (err) {
                showMessage('error', err.message);
            } finally { setLoading(false); swapBtn.disabled = false; }
        }

        function initModals() {
            // Resolve jQuery at init time
            const $ = window.django?.jQuery || window.jQuery;
            if (!$) {
                console.error('jQuery is required but not available');
                return;
            }
            
            // D√πng jQuery plugin Bootstrap 4 thay v√¨ new bootstrap.Modal()
            modals.add = { 
                show: () => $('#addScheduleModal').modal('show'),
                hide: () => $('#addScheduleModal').modal('hide')
            };
            modals.edit = { 
                show: () => $('#editScheduleModal').modal('show'),
                hide: () => $('#editScheduleModal').modal('hide')
            };
            modals.delete = { 
                show: () => $('#deleteConfirmModal').modal('show'),
                hide: () => $('#deleteConfirmModal').modal('hide')
            };
            modals.swap = { 
                show: () => $('#swapScheduleModal').modal('show'),
                hide: () => $('#swapScheduleModal').modal('hide')
            };
            modals.restore = {
                show: () => $('#restoreScheduleModal').modal('show'),
                hide: () => $('#restoreScheduleModal').modal('hide')
            };

            // Ensure global loading overlay is hidden when opening any modal
            ['addScheduleModal','editScheduleModal','deleteConfirmModal','swapScheduleModal','restoreScheduleModal'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    $(el).on('show.bs.modal', () => setLoading(false));
                }
            });
        }

        function bindButtons() {
            els.buttons.add.addEventListener('click', () => { 
                setLoading(false); 
                state.lastEmptySlot = null;
                modals.add.show(); 
                applyContextToAddModal({ lockTimeslot: false });
                const ts = document.getElementById('add-timeslot');
                if (ts) ts.disabled = false;
                autoFillAddModal(); 
                precheckGvAvailability('add');
            });
            els.buttons.edit.addEventListener('click', () => { if (!state.selected) return; setLoading(false); populateEditModal(state.selected); modals.edit.show(); });
            els.buttons.del.addEventListener('click', () => { if (!state.selected) return; setLoading(false); document.getElementById('delete-summary').textContent = `${state.selected.ma_lop} | ${state.selected.ma_phong || 'Ph√≤ng ?'} | Th·ª© ${state.selected.thu}, Ca ${state.selected.ca}`; modals.delete.show(); });
            els.buttons.swap.addEventListener('click', () => { if (state.selected) { document.getElementById('swap-select-a').value = state.selected.ma_tkb; } setLoading(false); modals.swap.show(); updateSwapInfo(); });
            els.buttons.restore.addEventListener('click', () => { if (state.selectedDeleted) startRestoreFlow(state.selectedDeleted); });
            document.getElementById('btnDeleteConfirm').addEventListener('click', deleteSchedule);
            document.getElementById('btnSwapSubmit').addEventListener('click', swapSchedules);
            document.getElementById('swap-select-a').addEventListener('change', updateSwapInfo);
            document.getElementById('swap-select-b').addEventListener('change', updateSwapInfo);
            document.getElementById('swap-phong').addEventListener('change', updateSwapInfo);
            document.getElementById('btnRestoreSubmit').addEventListener('click', handleRestoreSubmit);
        }

        function updateSwapInfo() {
            const aId = document.getElementById('swap-select-a').value;
            const bId = document.getElementById('swap-select-b').value;
            const findItem = (id) => state.schedule.find(x => x.ma_tkb === id);
            const a = findItem(aId);
            const b = findItem(bId);
            document.getElementById('swap-a-info').textContent = a ? `${a.mon_hoc || a.ma_lop} | ${a.ma_phong || 'Ph√≤ng ?'} | Th·ª© ${a.thu} - Ca ${a.ca}` : '';
            document.getElementById('swap-b-info').textContent = b ? `${b.mon_hoc || b.ma_lop} | ${b.ma_phong || 'Ph√≤ng ?'} | Th·ª© ${b.thu} - Ca ${b.ca}` : '';
            document.getElementById('btnSwapSubmit').disabled = !(a && b && a.ma_tkb !== b.ma_tkb);
            precheckSwapAvailability();
        }

        function bindFieldBehaviors() {
            document.getElementById('add-mon-hoc').addEventListener('change', handleAddMonHocChange);
            document.getElementById('add-timeslot').addEventListener('change', () => { filterRoomsByTimeslot('add'); precheckGvAvailability('add'); });
            document.getElementById('add-gv').addEventListener('change', () => precheckGvAvailability('add'));
            document.getElementById('add-soluongsv').addEventListener('input', () => handleAddMonHocChange());
            document.getElementById('edit-mon-hoc').addEventListener('change', handleEditMonHocChange);
            document.getElementById('edit-timeslot').addEventListener('change', () => { filterEditRoomsByTimeslot(); precheckGvAvailability('edit'); });
            document.getElementById('edit-soluongsv').addEventListener('input', () => handleEditMonHocChange());
        }

        function getTimeSlotIdByThuCa(thu, ca) {
            const options = document.querySelectorAll('#add-timeslot option');
            const targetDay = thu === 8 ? 'CN' : `Th·ª© ${thu}`;
            const targetCa = `Ca ${ca}`;
            for (const opt of options) {
                if (!opt.value) continue;
                if (opt.textContent.includes(targetDay) && opt.textContent.includes(targetCa)) return opt.value;
            }
            return '';
        }

        function setGvBusyState(prefix, message) {
            const hint = document.getElementById(`${prefix}-gv-busy-hint`);
            const btn = prefix === 'edit' ? document.getElementById('btnEditSubmit') : document.getElementById('btnAddSubmit');
            if (hint) {
                if (message) {
                    hint.textContent = message;
                    hint.classList.remove('d-none');
                    hint.style.display = 'block';
                } else {
                    hint.textContent = '';
                    hint.classList.add('d-none');
                }
            }
            if (btn) {
                btn.disabled = Boolean(message);
            }
        }

        async function precheckGvAvailability(prefix) {
            const ctx = getPageContext();
            const timeslotEl = document.getElementById(`${prefix}-timeslot`);
            const timeslotId = timeslotEl ? timeslotEl.value : '';
            const ma_gv = prefix === 'edit' ? (state.selected && state.selected.ma_gv) : document.getElementById('add-gv').value;
            const excludeMaTkb = prefix === 'edit' ? (state.selected && state.selected.ma_tkb) : '';
            if (!ma_gv || !timeslotId || !ctx.ma_dot) {
                setGvBusyState(prefix, '');
                return;
            }
            try {
                const res = await fetchJSON(`${api.gvSchedule}?ma_dot=${ctx.ma_dot}&ma_gv=${ma_gv}&time_slot_id=${encodeURIComponent(timeslotId)}${excludeMaTkb ? `&exclude_ma_tkb=${encodeURIComponent(excludeMaTkb)}` : ''}`);
                const data = await res.json();
                if (data.busy) {
                    setGvBusyState(prefix, 'Gi√°o vi√™n b·∫≠n ca n√†y. Ch·ªçn ca kh√°c.');
                } else {
                    setGvBusyState(prefix, '');
                }
            } catch (err) {
                console.error(err);
                setGvBusyState(prefix, 'Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c l·ªãch GV, th·ª≠ l·∫°i.');
            }
        }

        async function handleAddMonHocChange() {
            const maMonHoc = document.getElementById('add-mon-hoc').value;
            const infoDiv = document.getElementById('add-mon-hoc-info');
            const detailsDiv = document.getElementById('add-mon-hoc-details');
            if (!maMonHoc) { infoDiv.style.display = 'none'; return; }
            try {
                const res = await fetchJSON(`${api.monhoc}?ma_mon_hoc=${maMonHoc}`);
                const data = await res.json();
                if (data.status === 'success') {
                    const mon = data.mon_hoc; const suggested = data.suggested || {}; const usedGroups = data.used_groups || {};
                    infoDiv.style.display = 'block';
                    detailsDiv.textContent = `${mon.ten_mon_hoc} (${mon.ma_mon_hoc}) | Lo·∫°i: ${mon.loai}`;
                    const nhomSelect = document.getElementById('add-nhom');
                    const toSelect = document.getElementById('add-to');
                    Array.from(nhomSelect.options).forEach(opt => {
                        if (!opt.value) return;
                        const nhom = parseInt(opt.value, 10);
                        if (usedGroups[nhom]) {
                            opt.disabled = (mon.loai === 'LT' && usedGroups[nhom].some(x => x.to === 0)) || (mon.loai === 'TH' && usedGroups[nhom].length >= 2);
                            opt.text = opt.disabled ? `${nhom} (ƒë√£ ƒë·ªß)` : `${nhom} (ƒë√£ c√≥ t·ªï: ${usedGroups[nhom].map(x => x.to).join(',')})`;
                        } else { opt.disabled = false; opt.text = nhom; }
                    });
                    if (mon.loai === 'LT') { toSelect.value = '0'; Array.from(toSelect.options).forEach(o => o.disabled = o.value !== '0'); }
                    else { if (toSelect.value === '0') toSelect.value = '1'; Array.from(toSelect.options).forEach(o => o.disabled = o.value === '0'); }
                    if (suggested.nhom) { nhomSelect.value = suggested.nhom; if (suggested.to !== undefined) toSelect.value = suggested.to; document.getElementById('add-nhom-hint').textContent = `G·ª£i √Ω nh√≥m ${suggested.nhom}`; }
                    await filterRoomsByMonHoc('add', mon);
                    await filterRoomsByTimeslot('add');
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function handleEditMonHocChange() {
            const maMonHoc = document.getElementById('edit-mon-hoc').value;
            const infoDiv = document.getElementById('edit-mon-hoc-info');
            const detailsDiv = document.getElementById('edit-mon-hoc-details');
            if (!maMonHoc) { infoDiv.style.display = 'none'; return; }
            try {
                const res = await fetchJSON(`${api.monhoc}?ma_mon_hoc=${maMonHoc}`);
                const data = await res.json();
                if (data.status === 'success') {
                    const mon = data.mon_hoc; infoDiv.style.display = 'block'; detailsDiv.textContent = `${mon.ten_mon_hoc} (${mon.ma_mon_hoc}) | Lo·∫°i: ${mon.loai}`;
                    await filterRoomsByMonHoc('edit', mon);
                    await filterEditRoomsByTimeslot();
                }
            } catch (err) { console.error(err); }
        }

        async function filterRoomsByMonHoc(prefix, monHoc) {
            const roomSelect = document.getElementById(`${prefix}-phong`);
            const soLuongSV = parseInt(document.getElementById(`${prefix}-soluongsv`).value || '0', 10);
            const all = Array.from(roomSelect.options).slice(1);
            const keep = [];
            all.forEach(opt => {
                const loai = (opt.dataset.loai || '').toUpperCase();
                const text = opt.text; const match = text.match(/\((\d+) ch·ªó\)/); const sucChua = match ? parseInt(match[1], 10) : 999;
                const isLab = loai.includes('TH') || loai.includes('LAB') || loai.includes('M√ÅY');
                const isLecture = loai.includes('LT') || loai.includes('L√ù THUY·∫æT') || loai.includes('PH√íNG H·ªåC');
                const tooSmall = soLuongSV && sucChua < soLuongSV;
                const allowedType = monHoc.loai === 'TH' ? (isLab || (!isLab && !isLecture)) : (isLecture || (!isLab && !isLecture));
                const allowed = allowedType && !tooSmall;
                opt.disabled = !allowed;
                opt.style.display = allowed ? '' : 'none';
                if (allowed) keep.push(opt);
            });
            while (roomSelect.options.length > 1) roomSelect.remove(1);
            keep.forEach(o => roomSelect.add(o));
        }

        async function filterRoomsByTimeslot(prefix) {
            const select = document.getElementById(`${prefix}-timeslot`);
            const roomSelect = document.getElementById(`${prefix}-phong`);
            const timeslotId = select.value;
            if (!timeslotId) return;
            const ma_dot = document.getElementById('dotSelect').value || document.getElementById('add-ma-dot').value;
            try {
                const res = await fetchJSON(`${api.occupied}?ma_dot=${ma_dot}&time_slot_id=${encodeURIComponent(timeslotId)}`);
                const data = await res.json();
                const occupied = new Set(data.occupied_rooms || []);
                Array.from(roomSelect.options).forEach(opt => { if (!opt.value) return; opt.disabled = occupied.has(opt.value); opt.style.display = occupied.has(opt.value) ? 'none' : ''; });
            } catch (err) { console.error(err); }
        }

        async function filterEditRoomsByTimeslot() {
            const timeslotId = document.getElementById('edit-timeslot').value;
            const ma_tkb = document.getElementById('edit-ma-tkb').value;
            if (!timeslotId) return;
            const ma_dot = document.getElementById('dotSelect').value;
            try {
                const res = await fetchJSON(`${api.occupied}?ma_dot=${ma_dot}&time_slot_id=${encodeURIComponent(timeslotId)}&exclude_ma_tkb=${encodeURIComponent(ma_tkb)}`);
                const data = await res.json();
                const occupied = new Set(data.occupied_rooms || []);
                Array.from(document.getElementById('edit-phong').options).forEach(opt => { if (!opt.value) return; opt.disabled = occupied.has(opt.value); opt.style.display = occupied.has(opt.value) ? 'none' : ''; });
            } catch (err) { console.error(err); }
        }

        async function isRoomAvailable(timeslotId, roomId, excludeMaTkb) {
            if (!timeslotId || !roomId) {
                console.warn('isRoomAvailable: missing params', { timeslotId, roomId });
                return true;
            }
            const ma_dot = document.getElementById('dotSelect').value || document.getElementById('add-ma-dot').value;
            const excludeParam = excludeMaTkb ? `&exclude_ma_tkb=${encodeURIComponent(excludeMaTkb)}` : '';
            const url = `${api.occupied}?ma_dot=${ma_dot}&time_slot_id=${encodeURIComponent(timeslotId)}${excludeParam}`;
            console.log('isRoomAvailable checking:', { timeslotId, roomId, excludeMaTkb, url });
            try {
                const res = await fetchJSON(url);
                const data = await res.json();
                const occupied = new Set(data.occupied_rooms || []);
                const available = !occupied.has(roomId);
                console.log('isRoomAvailable result:', { roomId, occupied: Array.from(occupied), available });
                return available;
            } catch (err) {
                console.error('isRoomAvailable error:', err);
                return true;
            }
        }

        async function precheckSwapAvailability() {
            const warning = document.getElementById('swap-warning');
            const btn = document.getElementById('btnSwapSubmit');
            warning.classList.add('d-none');
            warning.textContent = '';
            const aId = document.getElementById('swap-select-a').value;
            const bId = document.getElementById('swap-select-b').value;
            const swapPhong = document.getElementById('swap-phong').checked;
            const findItem = (id) => state.schedule.find(x => x.ma_tkb === id);
            const a = findItem(aId);
            const b = findItem(bId);
            
            console.log('Precheck swap:', { aId, bId, a, b, swapPhong });
            
            if (!(a && b && a.ma_tkb !== b.ma_tkb)) { btn.disabled = true; return; }

            btn.disabled = true;
            try {
                const ctx = getPageContext();
                const conflicts = [];
                
                // ===== CHECK PH√íNG H·ªåC =====
                if (!swapPhong) {
                    // Ch·ªâ ƒë·ªïi timeslot: ki·ªÉm tra ph√≤ng A c√≥ r·∫£nh ·ªü timeslot B, ph√≤ng B c√≥ r·∫£nh ·ªü timeslot A
                    console.log('Check only timeslot swap:', { 
                        aRoom: a.ma_phong, bTimeslot: b.time_slot_id,
                        bRoom: b.ma_phong, aTimeslot: a.time_slot_id
                    });
                    const [roomAOk, roomBOk] = await Promise.all([
                        isRoomAvailable(b.time_slot_id, a.ma_phong, b.ma_tkb),
                        isRoomAvailable(a.time_slot_id, b.ma_phong, a.ma_tkb)
                    ]);
                    console.log('Timeslot swap result:', { roomAOk, roomBOk });
                    if (!roomAOk) conflicts.push(`Ph√≤ng ${a.ma_phong || '?'} kh√¥ng r·∫£nh t·∫°i timeslot Th·ª© ${b.thu} - Ca ${b.ca}`);
                    if (!roomBOk) conflicts.push(`Ph√≤ng ${b.ma_phong || '?'} kh√¥ng r·∫£nh t·∫°i timeslot Th·ª© ${a.thu} - Ca ${a.ca}`);
                } else {
                    // ƒê·ªïi c·∫£ ph√≤ng: ki·ªÉm tra ph√≤ng B c√≥ r·∫£nh ·ªü timeslot A, ph√≤ng A c√≥ r·∫£nh ·ªü timeslot B
                    console.log('Check full swap (room + timeslot):', {
                        bRoom: b.ma_phong, aTimeslot: a.time_slot_id,
                        aRoom: a.ma_phong, bTimeslot: b.time_slot_id
                    });
                    const [roomAOk, roomBOk] = await Promise.all([
                        isRoomAvailable(a.time_slot_id, b.ma_phong, a.ma_tkb),
                        isRoomAvailable(b.time_slot_id, a.ma_phong, b.ma_tkb)
                    ]);
                    console.log('Full swap result:', { roomAOk, roomBOk });
                    if (!roomAOk) conflicts.push(`Ph√≤ng ${b.ma_phong || '?'} kh√¥ng r·∫£nh t·∫°i timeslot Th·ª© ${a.thu} - Ca ${a.ca}`);
                    if (!roomBOk) conflicts.push(`Ph√≤ng ${a.ma_phong || '?'} kh√¥ng r·∫£nh t·∫°i timeslot Th·ª© ${b.thu} - Ca ${b.ca}`);
                }

                // ===== CHECK GI√ÅO VI√äN (h·ªó tr·ª£ swap kh√°c GV) =====
                // T·∫≠n d·ª•ng api.gvSchedule ƒë·ªÉ check xung ƒë·ªôt GV
                if (a.ma_gv && b.ma_gv && ctx.ma_dot) {
                    console.log('Check teacher conflicts:', { 
                        gvA: a.ma_gv, timeslotB: b.time_slot_id,
                        gvB: b.ma_gv, timeslotA: a.time_slot_id
                    });
                    
                    // Check GV A c√≥ b·∫≠n timeslot B kh√¥ng (exclude l·ªãch B)
                    // Check GV B c√≥ b·∫≠n timeslot A kh√¥ng (exclude l·ªãch A)
                    const [gvACheck, gvBCheck] = await Promise.all([
                        fetchJSON(`${api.gvSchedule}?ma_dot=${ctx.ma_dot}&ma_gv=${a.ma_gv}&time_slot_id=${encodeURIComponent(b.time_slot_id)}&exclude_ma_tkb=${encodeURIComponent(b.ma_tkb)}`),
                        fetchJSON(`${api.gvSchedule}?ma_dot=${ctx.ma_dot}&ma_gv=${b.ma_gv}&time_slot_id=${encodeURIComponent(a.time_slot_id)}&exclude_ma_tkb=${encodeURIComponent(a.ma_tkb)}`)
                    ]);
                    
                    const [dataA, dataB] = await Promise.all([
                        gvACheck.json(),
                        gvBCheck.json()
                    ]);
                    
                    console.log('Teacher check result:', { dataA, dataB });
                    
                    if (dataA.busy) {
                        conflicts.push(`GV ${a.ma_gv} ƒë√£ c√≥ l·ªãch t·∫°i Th·ª© ${b.thu} - Ca ${b.ca}`);
                    }
                    if (dataB.busy) {
                        conflicts.push(`GV ${b.ma_gv} ƒë√£ c√≥ l·ªãch t·∫°i Th·ª© ${a.thu} - Ca ${a.ca}`);
                    }
                }

                if (conflicts.length) {
                    warning.textContent = conflicts.join(' | ');
                    warning.classList.remove('d-none');
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
            } catch (err) {
                console.error('Precheck error:', err);
                warning.textContent = 'Kh√¥ng th·ªÉ ki·ªÉm tra, h√£y ti·∫øp t·ª•c - backend s·∫Ω ki·ªÉm tra';
                warning.classList.remove('d-none');
                btn.disabled = false;
            }
        }

        async function startRestoreFlow(item) {
            if (!item) return;
            const timeslotId = getTimeSlotIdByThuCa(item.thu, item.ca);
            if (!timeslotId) { showMessage('error', 'Kh√¥ng t√¨m th·∫•y timeslot ph√π h·ª£p ƒë·ªÉ ki·ªÉm tra ph√≤ng'); return; }
            const ma_dot = document.getElementById('dotSelect').value || document.getElementById('add-ma-dot').value;
            try {
                const res = await fetchJSON(`${api.occupied}?ma_dot=${ma_dot}&time_slot_id=${encodeURIComponent(timeslotId)}`);
                const data = await res.json();
                const occupied = new Set(data.occupied_rooms || []);
                const roomBusy = item.ma_phong && occupied.has(item.ma_phong);
                if (!roomBusy) {
                    try {
                        await restoreSchedule({ ma_tkb: item.ma_tkb });
                    } catch (err) {
                        // restoreSchedule already hi·ªÉn th·ªã th√¥ng b√°o l·ªói
                    }
                    return;
                }
                openRestoreModal(item, timeslotId, occupied);
            } catch (err) {
                showMessage('error', 'Kh√¥ng th·ªÉ ki·ªÉm tra ph√≤ng: ' + err.message);
            }
        }

        async function openRestoreModal(item, timeslotId, occupied) {
            state.restoreContext = { item, timeslotId, occupied };
            document.getElementById('restore-ma-tkb').value = item.ma_tkb;
            document.getElementById('restore-info').textContent = `${item.mon_hoc || item.ma_lop} | ${item.ma_lop} | Th·ª© ${item.thu} - Ca ${item.ca}`;
            document.getElementById('restore-timeslot').value = timeslotId;
            document.getElementById('restore-warning').classList.add('d-none');
            document.getElementById('restore-warning').textContent = '';
            document.getElementById('restore-phong').value = '';
            document.getElementById('restore-phong-hint').textContent = 'Ch·ªâ hi·ªÉn th·ªã ph√≤ng ch∆∞a b·ªã chi·∫øm trong ca n√†y.';
            document.getElementById('restore-hint').textContent = `Ph√≤ng g·ªëc ${item.ma_phong || 'N/A'} ƒëang b·∫≠n. Ch·ªçn ph√≤ng thay th·∫ø r·ªìi ph·ª•c h·ªìi.`;

            const parts = (item.ma_lop || '').split('_');
            const maMonHoc = parts.length >= 3 ? parts.slice(0, -2).join('_') : '';
            const soLuong = item.so_luong_sv || 0;
            document.getElementById('restore-soluongsv').value = soLuong;

            await filterRoomsByTimeslot('restore');
            if (maMonHoc) {
                try {
                    const res = await fetchJSON(`${api.monhoc}?ma_mon_hoc=${maMonHoc}`);
                    const data = await res.json();
                    if (data.status === 'success') {
                        await filterRoomsByMonHoc('restore', data.mon_hoc);
                        await filterRoomsByTimeslot('restore');
                    }
                } catch (err) {
                    console.error(err);
                }
            }
            modals.restore.show();
        }

        async function handleRestoreSubmit() {
            const ctx = state.restoreContext;
            if (!ctx) { modals.restore.hide(); return; }
            const room = document.getElementById('restore-phong').value;
            const warning = document.getElementById('restore-warning');
            warning.classList.add('d-none');
            warning.textContent = '';
            if (!room) {
                warning.textContent = 'Ch·ªçn ph√≤ng thay th·∫ø tr∆∞·ªõc khi ph·ª•c h·ªìi.';
                warning.classList.remove('d-none');
                return;
            }

            try {
                await restoreSchedule({ ma_tkb: ctx.item.ma_tkb, ma_phong_moi: room });
                state.restoreContext = null;
                modals.restore.hide();
            } catch (err) {
                warning.textContent = 'Backend ch∆∞a h·ªó tr·ª£ ƒë·ªïi ph√≤ng khi ph·ª•c h·ªìi. Vui l√≤ng gi·∫£i ph√≥ng ph√≤ng ho·∫∑c ph·ª•c h·ªìi r·ªìi d√πng ch·ª©c nƒÉng S·ª≠a khi slot tr·ªëng.';
                warning.classList.remove('d-none');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fixModalStacking();
            initModals();
            initTrashZone();  // Kh·ªüi t·∫°o trash zone
            bindButtons();
            bindForms();
            bindFieldBehaviors();
            loadSchedule();
            updateActionState();
            window.tkbPage = { updateFilters, handleViewTypeChange };
        });
    })();
</script>
{% endblock %}
