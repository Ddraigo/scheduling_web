{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Trang ch·ªß</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="row">
    <div class="col-md-12">
        <!-- Control Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>‚öôÔ∏è B·∫£ng ƒëi·ªÅu khi·ªÉn</h5>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label for="periodSelect">Ch·ªçn ƒë·ª£t x·∫øp:</label>
                    <select id="periodSelect" class="form-control">
                        <option value="">-- Ch·ªçn ƒë·ª£t --</option>
                        {% for period in periods %}
                        <option value="{{ period.ma_dot }}">
                            {{ period.ma_dot }} - {{ period.ten_dot }} ({{ period.trang_thai }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="testFetchData()">
                        üì• T·∫£i d·ªØ li·ªáu
                    </button>
                    <button type="button" class="btn btn-info" onclick="testPrepareCompact()">
                        üîß ƒê·ªãnh d·∫°ng compact
                    </button>
                    <button type="button" class="btn btn-warning" onclick="testBuildPrompt()">
                        üìù X√¢y d·ª±ng prompt
                    </button>
                    <button type="button" class="btn btn-success" onclick="testCallLLM()">
                        ü§ñ G·ªçi LLM
                    </button>
                </div>
                
                <hr>
                
                <button type="button" class="btn btn-lg btn-success" onclick="testFullPipeline()">
                    ‚ñ∂Ô∏è Ch·∫°y to√†n b·ªô quy tr√¨nh
                </button>
            </div>
        </div>
        
        <!-- Output Console -->
        <div class="card">
            <div class="card-header">
                <h5>üìä K·∫øt qu·∫£</h5>
            </div>
            <div class="card-body">
                <div id="outputConsole" style="background-color: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
                    ƒêang ch·ªù th·ª±c hi·ªán l·ªánh...
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .card {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 10px 15px;
    }
    .card-header h5 {
        margin: 0;
    }
    .card-body {
        padding: 15px;
    }
    #outputConsole {
        font-size: 12px;
        line-height: 1.4;
    }
    .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
    const apiBaseUrl = '/api/scheduling';
    
    function log(message, type = 'info') {
        const console = document.getElementById('outputConsole');
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        console.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
        console.scrollTop = console.scrollHeight;
    }
    
    function clearLog() {
        document.getElementById('outputConsole').innerHTML = '';
    }
    
    function getSelectedPeriod() {
        const select = document.getElementById('periodSelect');
        const periodId = select.value;
        if (!periodId) {
            log('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·ª£t x·∫øp!', 'error');
            return null;
        }
        return periodId;
    }
    
    async function testFetchData() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang t·∫£i d·ªØ li·ªáu cho ƒë·ª£t: ${periodId}...`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/schedule-llm/?period_id=${periodId}&step=fetch_data`);
            const data = await response.json();
            
            if (data.status === 'success') {
                log(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng d·ªØ li·ªáu`, 'success');
                log(`üìä Th·ªëng k√™:`);
                log(`   - L·ªõp m√¥n h·ªçc: ${data.data.classes?.length || 0}`);
                log(`   - Gi·∫£ng vi√™n: ${data.data.teachers?.length || 0}`);
                log(`   - Ph√≤ng h·ªçc: ${data.data.rooms?.length || 0}`);
                log(`   - Khung th·ªùi gian: ${data.data.time_slots?.length || 0}`);
                log(JSON.stringify(data.data, null, 2));
            } else {
                log(`‚ùå L·ªói: ${data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function testPrepareCompact() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang chu·∫©n b·ªã ƒë·ªãnh d·∫°ng compact cho ƒë·ª£t: ${periodId}...`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/schedule-llm/?period_id=${periodId}&step=prepare_compact`);
            const data = await response.json();
            
            if (data.status === 'success') {
                log(`‚úÖ ƒê√£ t·∫°o ƒë·ªãnh d·∫°ng compact`, 'success');
                log(JSON.stringify(data.data, null, 2));
            } else {
                log(`‚ùå L·ªói: ${data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function testBuildPrompt() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang x√¢y d·ª±ng prompt cho ƒë·ª£t: ${periodId}...`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/schedule-llm/?period_id=${periodId}&step=build_prompt`);
            const data = await response.json();
            
            if (data.status === 'success') {
                log(`‚úÖ ƒê√£ t·∫°o prompt`, 'success');
                log(`üìù Prompt preview (first 500 chars):`);
                log(data.data.prompt.substring(0, 500) + '...');
            } else {
                log(`‚ùå L·ªói: ${data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function testCallLLM() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang g·ªçi LLM ƒë·ªÉ t·∫°o l·ªãch cho ƒë·ª£t: ${periodId}...`);
        log(`‚è≥ ƒêang ch·ªù ph·∫£n h·ªìi t·ª´ LLM... (c√≥ th·ªÉ m·∫•t 10-30 gi√¢y)`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/schedule-llm/?period_id=${periodId}&step=call_llm`);
            const data = await response.json();
            
            if (data.status === 'success') {
                log(`‚úÖ LLM ƒë√£ ph·∫£n h·ªìi th√†nh c√¥ng`, 'success');
                log(`üìä K·∫øt qu·∫£:`);
                log(JSON.stringify(data.data, null, 2));
            } else {
                log(`‚ùå L·ªói: ${data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function testFullPipeline() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`üöÄ B·∫Øt ƒë·∫ßu quy tr√¨nh ho√†n ch·ªânh cho ƒë·ª£t: ${periodId}`);
        log(`‚è≥ ƒêang x·ª≠ l√Ω... (c√≥ th·ªÉ m·∫•t v√†i ph√∫t)`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/schedule-llm/?period_id=${periodId}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                log(`‚úÖ Ho√†n th√†nh quy tr√¨nh!`, 'success');
                log(`üìä K·∫øt qu·∫£ cu·ªëi c√πng:`);
                log(JSON.stringify(data.data, null, 2));
            } else {
                log(`‚ùå L·ªói: ${data.message}`, 'error');
                if (data.data) {
                    log(`Chi ti·∫øt l·ªói:`);
                    log(JSON.stringify(data.data, null, 2));
                }
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
</script>
{% endblock %}
