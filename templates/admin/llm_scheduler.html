{% extends "admin/base.html" %}
{% load static i18n %}

{% block title %}{{ title }} {% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Trang ch·ªß</a>
    &rsaquo; <a href="{% url 'admin:sap_lich_saplichproxy_changelist' %}">S·∫Øp l·ªãch</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}


{% block content %}

<!-- Control Panel -->
<div class="card mb-4">
    <div class="card-header">
        <h5>‚öôÔ∏è B·∫£ng ƒëi·ªÅu khi·ªÉn</h5>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label for="periodSelect">Ch·ªçn ƒë·ª£t x·∫øp:</label>
            <select id="periodSelect" class="form-control">
                <option value="">-- Ch·ªçn ƒë·ª£t --</option>
                {% for period in periods %}
                <option value="{{ period.ma_dot }}">
                    {{ period.ma_dot }} - {{ period.ten_dot }} ({{ period.trang_thai }})
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" onclick="testFetchData()">
                üì• T·∫£i d·ªØ li·ªáu
            </button>
            <button type="button" class="btn btn-info" onclick="testPrepareCompact()">
                üîß ƒê·ªãnh d·∫°ng compact
            </button>
            <button type="button" class="btn btn-warning" onclick="testBuildPrompt()">
                üìù X√¢y d·ª±ng prompt
            </button>
            <button type="button" class="btn btn-success" onclick="testCallLLM()">
                ü§ñ G·ªçi LLM
            </button>
        </div>
        
        <hr>
        
        <button type="button" class="btn btn-lg btn-success" onclick="testFullPipeline()">
            ‚ñ∂Ô∏è Ch·∫°y to√†n b·ªô quy tr√¨nh
        </button>
    </div>
</div>

<!-- Output Console -->
<div class="card">
    <div class="card-header">
        <h5>üìä K·∫øt qu·∫£</h5>
    </div>
    <div class="card-body">
        <div id="outputConsole" style="background-color: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            ƒêang ch·ªù th·ª±c hi·ªán l·ªánh...
        </div>
    </div>
</div>

{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    /* Force vertical stacking */
    #content-main {
        display: block !important;
        width: 100% !important;
    }
    
    .card {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
        width: 100% !important;
        display: block !important;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 10px 15px;
    }
    .card-header h5 {
        margin: 0;
    }
    .card-body {
        padding: 15px;
    }
    #outputConsole {
        font-size: 12px;
        line-height: 1.4;
    }
    .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
    const apiBaseUrl = '/api/scheduling';
    
    function log(message, type = 'info') {
        const console = document.getElementById('outputConsole');
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        console.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
        console.scrollTop = console.scrollHeight;
    }
    
    function clearLog() {
        document.getElementById('outputConsole').innerHTML = '';
    }
    
    function getSelectedPeriod() {
        const select = document.getElementById('periodSelect');
        const periodId = select.value;
        if (!periodId) {
            log('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·ª£t x·∫øp!', 'error');
            return null;
        }
        return periodId;
    }
    
    async function testFetchData() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang t·∫£i d·ªØ li·ªáu cho ƒë·ª£t: ${periodId}...`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/llm_scheduler/?period_id=${periodId}&step=fetch_data`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng d·ªØ li·ªáu`, 'success');
                log(`üìä Th·ªëng k√™ chi ti·∫øt:`);
                if (data.stats) {
                    log(`   üìå L·ªõp & Gi·∫£ng vi√™n:`);
                    log(`      ‚Ä¢ Ph√¢n c√¥ng: ${data.stats.phan_cong_count || 0} l·ªõp`);
                    log(`      ‚Ä¢ Gi·∫£ng vi√™n: ${data.stats.teachers_count || 0} ng∆∞·ªùi`);
                    log(`   üìå Ph√≤ng h·ªçc:`);
                    log(`      ‚Ä¢ T·ªïng ph√≤ng: ${data.stats.rooms_count || 0}`);
                    log(`      ‚Ä¢ Ph√≤ng LT: ${data.stats.rooms_lt || 0}`);
                    log(`      ‚Ä¢ Ph√≤ng TH: ${data.stats.rooms_th || 0}`);
                    log(`   üìå Th·ªùi gian & R√†ng bu·ªôc:`);
                    log(`      ‚Ä¢ Khung th·ªùi gian: ${data.stats.timeslots_count || 0}`);
                    log(`      ‚Ä¢ R√†ng bu·ªôc m·ªÅm: ${data.stats.constraints_custom || 0}`);
                    log(`      ‚Ä¢ Nguy·ªán v·ªçng: ${data.stats.preferences_count || 0}`);
                }
            } else {
                log(`‚ùå L·ªói: ${data.error || data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function prepareCompactData() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`Chu·∫©n b·ªã d·ªØ li·ªáu compact cho ƒë·ª£t: ${periodId}...`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/llm_scheduler/?period_id=${periodId}&step=prepare_compact`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ ƒê√£ t·∫°o ƒë·ªãnh d·∫°ng compact`, 'success');
                log(`üìä Th·ªëng k√™: ${JSON.stringify(data.stats, null, 2)}`);
            } else {
                log(`‚ùå L·ªói: ${data.error || data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function testBuildPrompt() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang x√¢y d·ª±ng prompt cho ƒë·ª£t: ${periodId}...`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/llm_scheduler/?period_id=${periodId}&step=build_prompt`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ ƒê√£ t·∫°o prompt`, 'success');
                log(`üìù K√≠ch th∆∞·ªõc prompt: ${data.prompt.prompt_length} k√Ω t·ª±`);
                log(`üìù Xem tr∆∞·ªõc:`);
                log(data.prompt.prompt_preview);
            } else {
                log(`‚ùå L·ªói: ${data.error || data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function testCallLLM() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`ƒêang g·ªçi LLM ƒë·ªÉ t·∫°o l·ªãch cho ƒë·ª£t: ${periodId}...`);
        log(`‚è≥ ƒêang ch·ªù ph·∫£n h·ªìi t·ª´ LLM... (c√≥ th·ªÉ m·∫•t 10-30 gi√¢y)`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/llm_scheduler/?period_id=${periodId}&step=call_llm`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ LLM ƒë√£ ph·∫£n h·ªìi th√†nh c√¥ng`, 'success');
                if (data.llm_result) {
                    log(`üìä S·ªë l·ªãch t·∫°o ƒë∆∞·ª£c: ${data.llm_result.schedule_count}`);
                    if (data.llm_result.has_errors) {
                        log(`‚ö†Ô∏è C√≥ l·ªói trong l·ªãch ƒë∆∞·ª£c t·∫°o`, 'warning');
                    }
                }
            } else {
                log(`‚ùå L·ªói: ${data.error || data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
    
    async function testFullPipeline() {
        clearLog();
        const periodId = getSelectedPeriod();
        if (!periodId) return;
        
        log(`üöÄ B·∫Øt ƒë·∫ßu quy tr√¨nh ho√†n ch·ªânh cho ƒë·ª£t: ${periodId}`);
        log(`‚è≥ ƒêang x·ª≠ l√Ω... (c√≥ th·ªÉ m·∫•t v√†i ph√∫t)`);
        
        try {
            const response = await fetch(`${apiBaseUrl}/llm_scheduler/?period_id=${periodId}&step=generate_schedule`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ Ho√†n th√†nh quy tr√¨nh!`, 'success');
                log(`üìä K·∫øt qu·∫£ cu·ªëi c√πng:`);
                log(JSON.stringify(data, null, 2));
            } else {
                log(`‚ùå L·ªói: ${data.error || data.message}`, 'error');
            }
        } catch (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
        }
    }
</script>
{% endblock %}
