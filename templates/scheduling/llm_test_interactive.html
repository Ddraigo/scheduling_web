{% extends 'layouts/base.html' %}

{% block title %}LLM Schedule Generation Test{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>ü§ñ LLM Schedule Generation - Interactive Test</h1>
    
    <div class="row">
        <div class="col-md-8">
            <!-- Control Panel -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5>‚öôÔ∏è Control Panel</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="periodSelect">Select Period:</label>
                        <select id="periodSelect" class="form-control">
                            <option value="">-- Choose a period --</option>
                            {% for period in periods %}
                            <option value="{{ period.ma_dot }}">
                                {{ period.ma_dot }} - {{ period.ten_dot }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="testFetchData()">
                            üì• Fetch Data
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="testPrepareCompact()">
                            üîß Compact Format
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="testBuildPrompt()">
                            üìù Build Prompt
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="testCallLLM()">
                            ü§ñ Call LLM
                        </button>
                    </div>
                    
                    <hr>
                    
                    <button type="button" class="btn btn-lg btn-success w-100" onclick="testFullPipeline()">
                        ‚ñ∂Ô∏è Run Full End-to-End Test
                    </button>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5>üìä Results</h5>
                </div>
                <div class="card-body">
                    <div id="resultsContainer">
                        <p class="text-muted">Results will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Info Panel -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5>‚ÑπÔ∏è Info</h5>
                </div>
                <div class="card-body">
                    <h6>Token Optimization</h6>
                    <ul>
                        <li>Full format: 168 KB</li>
                        <li>Compact: 51.5 KB</li>
                        <li>Reduction: <strong>71%</strong></li>
                    </ul>
                    
                    <h6 class="mt-3">Pipeline Steps</h6>
                    <ol>
                        <li>Fetch data from DB</li>
                        <li>Convert to compact format</li>
                        <li>Build LLM prompt</li>
                        <li>Call Gemini LLM</li>
                        <li>Parse response</li>
                        <li>Validate format</li>
                    </ol>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-warning">
                    <h5>üìö Documentation</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li><a href="/docs/token-optimization">Token Optimization</a></li>
                        <li><a href="/docs/slot-mapping">Slot Mapping</a></li>
                        <li><a href="/docs/architecture">Architecture</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .result-box {
        background: #f8f9fa;
        border-left: 4px solid #28a745;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
    }
    
    .result-box.error {
        border-left-color: #dc3545;
    }
    
    .result-box.info {
        border-left-color: #17a2b8;
    }
    
    .step-item {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .step-success {
        color: #28a745;
        font-weight: bold;
    }
    
    .step-error {
        color: #dc3545;
        font-weight: bold;
    }
    
    .step-running {
        color: #ffc107;
    }
</style>

<script>
function getPeriod() {
    const period = document.getElementById('periodSelect').value;
    if (!period) {
        showError('Please select a period first');
        return null;
    }
    return period;
}

function showError(msg) {
    const html = `<div class="result-box error">‚ùå Error: ${msg}</div>`;
    document.getElementById('resultsContainer').innerHTML = html;
}

function showSuccess(msg) {
    const html = `<div class="result-box">‚úì ${msg}</div>`;
    document.getElementById('resultsContainer').innerHTML += html;
}

function showInfo(msg) {
    const html = `<div class="result-box info">‚ÑπÔ∏è ${msg}</div>`;
    document.getElementById('resultsContainer').innerHTML += html;
}

function testFetchData() {
    const ma_dot = getPeriod();
    if (!ma_dot) return;
    
    document.getElementById('resultsContainer').innerHTML = '<div class="loading"></div> Fetching data...';
    
    fetch('{% url "llm_test_interactive" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'fetch_data', ma_dot: ma_dot})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="result-box">
                    ‚úì Data fetched successfully!
                    <br><br>
                    <strong>Statistics:</strong>
                    <ul>
                        <li>Classes: ${data.data.classes}</li>
                        <li>Rooms (LT): ${data.data.rooms_lt}</li>
                        <li>Rooms (TH): ${data.data.rooms_th}</li>
                        <li>Teachers: ${data.data.teachers}</li>
                        <li>Constraints: ${data.data.constraints}</li>
                        <li>Preferences: ${data.data.preferences}</li>
                    </ul>
                </div>
            `;
        }
    })
    .catch(e => showError(e.message));
}

function testPrepareCompact() {
    const ma_dot = getPeriod();
    if (!ma_dot) return;
    
    document.getElementById('resultsContainer').innerHTML = '<div class="loading"></div> Preparing compact format...';
    
    fetch('{% url "llm_test_interactive" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'prepare_compact', ma_dot: ma_dot})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            const opt = data.optimization;
            document.getElementById('resultsContainer').innerHTML = `
                <div class="result-box">
                    ‚úì Compact format prepared!
                    <br><br>
                    <strong>Token Optimization:</strong>
                    <ul>
                        <li>Full format: ${(opt.full_bytes / 1024).toFixed(2)} KB</li>
                        <li>Compact: ${(opt.compact_bytes / 1024).toFixed(2)} KB</li>
                        <li><strong style="color: green;">Reduction: ${opt.reduction_percent}%</strong></li>
                        <li>Slot mapping: ${opt.slot_mapping_count} entries</li>
                    </ul>
                </div>
            `;
        }
    })
    .catch(e => showError(e.message));
}

function testBuildPrompt() {
    const ma_dot = getPeriod();
    if (!ma_dot) return;
    
    document.getElementById('resultsContainer').innerHTML = '<div class="loading"></div> Building LLM prompt...';
    
    fetch('{% url "llm_test_interactive" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'build_prompt', ma_dot: ma_dot})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            const p = data.prompt;
            document.getElementById('resultsContainer').innerHTML = `
                <div class="result-box">
                    ‚úì LLM prompt built!
                    <br><br>
                    <strong>Prompt Details:</strong>
                    <ul>
                        <li>Length: ${p.length} characters</li>
                        <li>Estimated tokens: ${p.estimated_tokens}</li>
                    </ul>
                    <br>
                    <strong>Preview:</strong>
                    <pre>${p.preview.substring(0, 300)}...</pre>
                </div>
            `;
        }
    })
    .catch(e => showError(e.message));
}

function testCallLLM() {
    const ma_dot = getPeriod();
    if (!ma_dot) return;
    
    document.getElementById('resultsContainer').innerHTML = '<div class="loading"></div> Calling LLM (this takes 10-30 seconds)...';
    
    fetch('{% url "llm_test_interactive" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'call_llm', ma_dot: ma_dot})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            const llm = data.llm_result;
            let sampleHtml = '';
            if (llm.sample_assignments && llm.sample_assignments.length > 0) {
                sampleHtml = '<strong>Sample assignments (first 3):</strong><ul>';
                llm.sample_assignments.forEach(a => {
                    sampleHtml += `<li>${JSON.stringify(a)}</li>`;
                });
                sampleHtml += '</ul>';
            }
            document.getElementById('resultsContainer').innerHTML = `
                <div class="result-box">
                    ‚úì LLM call successful!
                    <br><br>
                    <strong>Results:</strong>
                    <ul>
                        <li>Assignments: ${llm.schedule_count}</li>
                        <li>Errors: ${llm.error_count}</li>
                    </ul>
                    ${sampleHtml}
                </div>
            `;
        }
    })
    .catch(e => showError(e.message));
}

function testFullPipeline() {
    const ma_dot = getPeriod();
    if (!ma_dot) return;
    
    document.getElementById('resultsContainer').innerHTML = '<div class="loading"></div> Running full pipeline...';
    
    fetch('{% url "llm_test_interactive" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'full_test', ma_dot: ma_dot})
    })
    .then(r => r.json())
    .then(data => {
        let html = '';
        if (data.success) {
            html += '<div class="result-box"><strong style="color: green;">‚úì Full pipeline succeeded!</strong></div>';
        } else {
            html += '<div class="result-box error"><strong>‚ùå Pipeline failed</strong></div>';
            if (data.error) {
                html += `<div class="result-box error">${data.error}</div>`;
            }
        }
        
        html += '<strong>Steps:</strong>';
        data.steps.forEach(step => {
            const statusClass = `step-${step.status}`;
            const statusIcon = step.status === 'success' ? '‚úì' : (step.status === 'error' ? '‚ùå' : '‚è≥');
            html += `
                <div class="step-item">
                    <span>${statusIcon} ${step.name}</span>
                    <span class="${statusClass}">${step.info || step.status}</span>
                </div>
            `;
        });
        
        // Add download button if file was generated
        if (data.output_file) {
            html += `
                <div style="margin-top: 20px;">
                    <a href="/llm-test/download/?file=${data.output_file}" class="btn btn-primary" download>
                        üì• Download JSON Output
                    </a>
                    <span style="color: #666; margin-left: 10px;">${data.output_file}</span>
                </div>
            `;
        }
        
        document.getElementById('resultsContainer').innerHTML = html;
    })
    .catch(e => showError(e.message));
}
</script>
{% endblock %}
